<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focus Arena – Ultimate Productivity</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">
    <style>
        /* ===== CSS RESET & VARIABLES ===== */
        :root {
            --primary: #00D4FF;
            --primary-dark: #0099CC;
            --secondary: #9D4EDD;
            --accent: #FF6B6B;
            --success: #4CAF50;
            --warning: #FF9800;
            --dark: #121212;
            --darker: #0A0A0A;
            --light: #F8F9FA;
            --gray: #2D2D2D;
            --gray-light: #3D3D3D;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --radius: 16px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, #1A1A2E 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== MOBILE-FRIENDLY HEADER ===== */
        header {
            background: rgba(18, 18, 18, 0.98);
            backdrop-filter: blur(15px);
            padding: 0.5rem 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: var(--transition);
            height: 56px;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            flex-shrink: 0;
            min-width: auto;
        }

        .logo-icon {
            color: var(--primary);
            font-size: 1.4rem;
            filter: drop-shadow(0 0 6px rgba(0, 212, 255, 0.5));
            transition: var(--transition);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo h1 {
            font-size: 1.1rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            white-space: nowrap;
        }

        /* User stats - Compact mobile layout */
        .user-stats {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            flex-wrap: nowrap;
            justify-content: flex-end;
        }

        .label-container {
            display: inline-block;
            margin: 0;
        }

        .label {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.75rem;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            cursor: default;
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
            height: 28px;
        }

        .label-primary {
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
        }

        .label-secondary {
            color: var(--secondary);
            border-color: var(--secondary);
            background: rgba(157, 78, 221, 0.1);
        }

        .label-accent {
            color: var(--accent);
            border-color: var(--accent);
            background: rgba(255, 107, 107, 0.1);
        }

        .label-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--accent);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 800;
            z-index: 1;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--light);
            padding: 0.4rem 0.7rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            height: 28px;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: var(--accent);
            color: white;
        }

        /* ===== COMPACT NAVIGATION ===== */
        .nav-container {
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(15px);
            padding: 0.4rem 0.8rem;
            position: sticky;
            top: 56px;
            z-index: 999;
            overflow-x: auto;
            scrollbar-width: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 48px;
            display: flex;
            align-items: center;
        }

        .nav-container::-webkit-scrollbar {
            display: none;
        }

        nav {
            display: flex;
            gap: 0.4rem;
            min-width: max-content;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.7);
            padding: 0.5rem 0.6rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: var(--transition);
            white-space: nowrap;
            flex: 1;
            justify-content: center;
            cursor: pointer;
            height: 32px;
            min-width: 0;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: var(--primary);
            color: var(--dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            border-color: var(--primary);
        }

        /* ===== PROFILE SETUP ===== */
        .profile-setup-container {
            display: flex;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, #0A0A0A 0%, #1A1A2E 100%);
        }

        .profile-box {
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .profile-logo i {
            color: var(--primary);
            font-size: 2.5rem;
            filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.5));
        }

        .profile-logo h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .profile-subtitle {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: white;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .avatar-selection {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }

        /* ===== MAIN APP ===== */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: block;
        }

        /* ===== SECTIONS ===== */
        .sections-container {
            position: relative;
            min-height: calc(100vh - 104px);
            padding: 1rem;
            margin-top: 0;
        }

        section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        section.active {
            display: block;
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            font-weight: 800;
        }

        .section-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        /* ===== TIMER ===== */
        .mode-switcher {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            padding: 0.6rem 1rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.9rem;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        /* ORB */
        .orb-section {
            text-align: center;
            padding: 1.5rem 0;
        }

        .orb-container {
            position: relative;
            width: 240px;
            height: 240px;
            margin: 0 auto 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .orb-container:hover {
            transform: scale(1.05);
        }

        .orb {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, 
                rgba(0, 212, 255, 0.9) 0%, 
                rgba(157, 78, 221, 0.7) 50%, 
                transparent 70%);
            box-shadow: 
                inset 0 0 50px rgba(255, 255, 255, 0.1),
                0 0 80px rgba(0, 212, 255, 0.6),
                0 0 120px rgba(157, 78, 221, 0.4);
            position: relative;
            overflow: hidden;
            animation: orbPulse 4s infinite alternate ease-in-out;
        }

        @keyframes orbPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .time-display {
            font-size: 3.5rem;
            font-weight: 800;
            text-align: center;
            margin: 1rem 0;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.7);
            background: linear-gradient(90deg, var(--primary), var(--secondary), #FF6B6B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .timer-inputs {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .time-input {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            padding: 0.8rem;
            font-size: 1.2rem;
            color: white;
            text-align: center;
            width: 100px;
            transition: var(--transition);
        }

        .time-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            outline: none;
            transform: translateY(-2px);
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: var(--radius);
            font-weight: 600;
            transition: var(--transition);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .preset-btn:hover {
            background: var(--primary);
            color: var(--dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        /* CONTROL BUTTONS */
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            transition: var(--transition);
            cursor: pointer;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-start {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.4);
        }

        .btn-pause {
            background: linear-gradient(135deg, #FFB347, #FF8C00);
            color: white;
            box-shadow: 0 6px 25px rgba(255, 140, 0, 0.4);
        }

        .btn-reset {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            color: white;
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.4);
        }

        .btn-stopwatch {
            background: linear-gradient(135deg, #9D4EDD, #7B2CBF);
            color: white;
            box-shadow: 0 6px 25px rgba(157, 78, 221, 0.4);
        }

        /* ===== TO-DO LIST ===== */
        .todo-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 1.5rem;
        }

        .todo-input-container {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }

        .todo-input {
            flex: 1;
            padding: 0.7rem 0.9rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: white;
            font-size: 0.95rem;
            min-width: 200px;
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            transition: var(--transition);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .todo-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: rgba(255, 255, 255, 0.5);
        }

        .todo-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .todo-checkbox.checked {
            background: var(--primary);
        }

        .todo-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .todo-text {
            flex: 1;
            font-size: 0.95rem;
        }

        .todo-priority {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-high { background: rgba(255, 107, 107, 0.2); color: #FF6B6B; }
        .priority-medium { background: rgba(255, 193, 7, 0.2); color: #FFC107; }
        .priority-low { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }

        .todo-delete {
            background: transparent;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .todo-delete:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        /* ===== NOTES ===== */
        .notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.2rem;
            margin-top: 1.5rem;
        }

        .note-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            cursor: pointer;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .note-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .note-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .note-content {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 0.8rem;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-date {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-actions {
            display: flex;
            gap: 0.4rem;
        }

        .note-action-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .note-action-btn:hover {
            color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
        }

        /* ===== CALENDAR ===== */
        .calendar-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            margin-top: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-nav-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .calendar-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.4rem;
        }

        .calendar-day {
            text-align: center;
            padding: 0.4rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .calendar-date {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.03);
        }

        .calendar-date:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .calendar-date.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .calendar-date.has-focus {
            background: rgba(0, 212, 255, 0.2);
            position: relative;
        }

        .calendar-date.has-focus::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
        }

        .calendar-date.today {
            border: 2px solid var(--primary);
        }

        /* ===== HABITS ===== */
        .habits-container {
            margin-top: 1.5rem;
        }

        .habit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .habit-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease;
        }

        .habit-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .habit-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--light);
        }

        .habit-streak {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .habit-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin-bottom: 0.8rem;
            line-height: 1.5;
        }

        .habit-progress {
            margin-top: 0.8rem;
        }

        .progress-bar {
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transition: width 1s ease;
        }

        .habit-check {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.8rem;
        }

        .habit-check-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .habit-check-btn:hover {
            background: var(--success);
            color: white;
            transform: translateY(-2px);
        }

        .habit-check-btn.checked {
            background: var(--success);
            color: white;
        }

        /* ===== CHARTS ===== */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.2rem;
            margin-top: 1.5rem;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeInUp 0.5s ease;
        }

        .chart-card:hover {
            border-color: var(--primary);
        }

        .chart-title {
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* ===== MARKETPLACE ===== */
        .market-filters {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .filter-btn.active {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.2rem;
            margin-top: 1.2rem;
        }

        .market-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            cursor: pointer;
            animation: fadeIn 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        .market-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .market-item.owned {
            background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(0, 212, 255, 0.05));
            border-color: var(--secondary);
        }

        .item-badge {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: var(--accent);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 1;
        }

        .item-icon {
            font-size: 2.2rem;
            margin-bottom: 0.8rem;
            text-align: center;
            color: var(--primary);
            transition: var(--transition);
        }

        .market-item:hover .item-icon {
            transform: scale(1.2) rotate(5deg);
        }

        .item-name {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-align: center;
        }

        .item-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
            line-height: 1.5;
            text-align: center;
        }

        .item-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.8rem;
        }

        .price-tag {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .buy-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .buy-btn.owned {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }

        .item-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 0.8rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .rarity {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .rarity.common { background: rgba(255, 255, 255, 0.1); color: #aaa; }
        .rarity.uncommon { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .rarity.rare { background: rgba(33, 150, 243, 0.2); color: #2196F3; }
        .rarity.epic { background: rgba(157, 78, 221, 0.2); color: #9D4EDD; }
        .rarity.legendary { background: rgba(255, 193, 7, 0.2); color: #FFC107; }

        /* ===== STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .stat-icon {
            font-size: 2.2rem;
            margin-bottom: 0.8rem;
            color: var(--primary);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ===== GAME FEATURES ===== */
        .quests-container {
            margin-top: 1.5rem;
        }

        .quest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .quest-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease;
        }

        .quest-card.completed {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .quest-card:hover {
            transform: translateY(-3px);
        }

        .quest-reward {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--primary);
            font-weight: 600;
            margin-top: 0.8rem;
            font-size: 0.9rem;
        }

        /* ===== APP RESTRICTION ===== */
        .restriction-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
        }

        .restriction-timer {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 1.5rem 0;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.7);
        }

        .restriction-message {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 500px;
            line-height: 1.6;
        }

        /* ===== FOCUS MUSIC ===== */
        .focus-music {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .focus-music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .music-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .music-track:hover {
            background: rgba(0, 212, 255, 0.1);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .music-track.playing {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 212, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0); }
        }

        /* ===== ACHIEVEMENTS ===== */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.2rem;
            margin-top: 1.5rem;
        }

        .achievement-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease;
        }

        .achievement-card.unlocked {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), transparent);
        }

        .achievement-card:hover {
            transform: translateY(-5px);
        }

        .achievement-icon {
            font-size: 2.2rem;
            margin-bottom: 0.8rem;
            text-align: center;
            color: var(--primary);
        }

        .achievement-progress {
            margin-top: 0.8rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ===== SETTINGS ===== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.2rem;
            margin-top: 1.5rem;
        }

        .setting-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-option:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: rgba(18, 18, 18, 0.95);
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }

        /* ===== NOTIFICATION ===== */
        .notification {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 0.8rem 1.2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
            font-size: 0.9rem;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== EXIT WARNING ===== */
        .exit-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(18, 18, 18, 0.95);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 2px solid var(--accent);
            z-index: 10000;
            text-align: center;
            display: none;
        }

        /* ===== MUSIC PLAYER ===== */
        .music-player-active {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(18, 18, 18, 0.9);
            border: 1px solid var(--primary);
            border-radius: var(--radius);
            padding: 0.8rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            display: none;
            animation: slideInUp 0.3s ease;
            max-width: 200px;
        }

        @keyframes slideInUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ===== PROGRESS ANIMATIONS ===== */
        @keyframes progressFill {
            from { width: 0%; }
            to { width: 100%; }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* ===== CONFETTI ===== */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary);
            top: -10px;
            z-index: 9999;
            animation: confettiFall 5s linear forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            /* Header adjustments for tablet */
            header {
                padding: 0.4rem 0.6rem;
                height: 52px;
            }
            
            .logo-icon {
                font-size: 1.3rem;
                width: 26px;
                height: 26px;
            }
            
            .logo h1 {
                font-size: 1rem;
            }
            
            .label {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
                height: 26px;
            }
            
            .logout-btn {
                padding: 0.35rem 0.6rem;
                font-size: 0.7rem;
                height: 26px;
            }
            
            /* Navigation adjustments */
            .nav-container {
                top: 52px;
                height: 46px;
                padding: 0.3rem 0.6rem;
            }
            
            .nav-btn {
                padding: 0.4rem 0.5rem;
                font-size: 0.7rem;
                height: 30px;
                gap: 0.2rem;
            }
            
            /* Content adjustments */
            .sections-container {
                min-height: calc(100vh - 98px);
            }
            
            .time-display {
                font-size: 3rem;
            }
            
            .orb-container {
                width: 200px;
                height: 200px;
            }
            
            .control-btn {
                min-width: 120px;
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 220px;
            }
            
            .marketplace-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }

        @media (max-width: 480px) {
            /* Header adjustments for mobile */
            header {
                padding: 0.3rem 0.5rem;
                height: 50px;
            }
            
            .logo h1 {
                font-size: 0.9rem;
            }
            
            .logo-icon {
                font-size: 1.2rem;
                width: 24px;
                height: 24px;
            }
            
            /* Hide some text on very small screens */
            .label span:not(.label-badge) {
                display: none;
            }
            
            .label {
                padding: 0.3rem 0.4rem;
                min-width: 32px;
                justify-content: center;
            }
            
            .logout-btn span {
                display: none;
            }
            
            .logout-btn {
                padding: 0.3rem 0.4rem;
                min-width: 32px;
                justify-content: center;
            }
            
            /* Navigation adjustments */
            .nav-container {
                top: 50px;
                height: 44px;
                padding: 0.3rem 0.4rem;
            }
            
            .nav-btn {
                min-width: 40px;
                padding: 0.3rem 0.4rem;
                justify-content: center;
            }
            
            .nav-btn span {
                display: none;
            }
            
            .nav-btn i {
                font-size: 0.9rem;
                margin: 0;
            }
            
            /* Content adjustments */
            .sections-container {
                min-height: calc(100vh - 94px);
                padding: 0.8rem;
            }
            
            .section-title {
                font-size: 1.7rem;
            }
            
            .time-display {
                font-size: 2.5rem;
            }
            
            .orb-container {
                width: 180px;
                height: 180px;
            }
            
            .time-input {
                width: 70px;
                padding: 0.6rem;
                font-size: 1rem;
            }
            
            .control-btn {
                min-width: 100px;
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .todo-input-container {
                flex-direction: column;
                gap: 0.6rem;
            }
            
            .todo-input {
                min-width: 100%;
            }
            
            .notes-container,
            .habit-grid,
            .quest-grid,
            .achievements-grid,
            .settings-grid,
            .focus-music-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 200px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .marketplace-grid {
                grid-template-columns: 1fr;
            }
            
            .restriction-timer {
                font-size: 2.8rem;
            }
        }

        @media (max-width: 360px) {
            /* Extra small screens */
            header {
                padding: 0.3rem 0.4rem;
                height: 48px;
            }
            
            .logo h1 {
                font-size: 0.8rem;
            }
            
            .nav-container {
                top: 48px;
                height: 42px;
            }
            
            .sections-container {
                min-height: calc(100vh - 90px);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .control-btn,
            .nav-btn,
            .mode-btn,
            .preset-btn,
            .filter-btn {
                min-height: 44px;
            }
            
            .label,
            .logout-btn {
                min-height: 36px;
            }
            
            input,
            select,
            textarea,
            button {
                font-size: 16px !important; /* Prevents iOS zoom on focus */
            }
        }
    </style>
</head>
<body>
    <!-- PROFILE SETUP -->
    <div id="profileSetup" class="profile-setup-container">
        <div class="profile-box">
            <div class="profile-header">
                <div class="profile-logo">
                    <i class="fas fa-bullseye"></i>
                    <h1>FOCUS ARENA</h1>
                </div>
                <h2>Welcome! Create Your Profile 🎮</h2>
                <p class="profile-subtitle">Personalize your productivity journey</p>
            </div>
            
            <form id="profileForm">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Your Name</label>
                    <input type="text" id="username" placeholder="Enter your name" required>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-smile"></i> Choose Avatar</label>
                    <div class="avatar-selection" id="avatarSelection"></div>
                </div>
                
                <div class="form-group">
                    <label for="focusGoal"><i class="fas fa-bullseye"></i> Daily Focus Goal (minutes)</label>
                    <input type="number" id="focusGoal" min="15" max="480" value="120" required>
                </div>
                
                <div class="form-group">
                    <label for="dailyQuote"><i class="fas fa-quote-left"></i> Daily Motivation Quote</label>
                    <textarea id="dailyQuote" placeholder="Enter your favorite motivation quote..." rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productivityTheme"><i class="fas fa-palette"></i> Productivity Theme</label>
                    <select id="productivityTheme" class="time-input">
                        <option value="deep_work">Deep Work</option>
                        <option value="creative_flow">Creative Flow</option>
                        <option value="study_sessions">Study Sessions</option>
                        <option value="work_sprints">Work Sprints</option>
                    </select>
                </div>
                
                <button type="submit" class="auth-btn">
                    <i class="fas fa-rocket"></i> Start Productivity Journey
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="app-container">
        <!-- Header - COMPACT MOBILE VERSION -->
        <header>
            <div class="logo" onclick="showSection('play')">
                <div class="logo-icon"><i class="fas fa-bullseye"></i></div>
                <h1>FOCUS ARENA</h1>
            </div>
            <div class="user-stats">
                <div class="label-container">
                    <span class="label label-primary" onclick="showSection('marketplace')">
                        <i class="fas fa-coins"></i> <span id="coins">0</span>
                    </span>
                </div>
                <div class="label-container">
                    <span class="label label-secondary" onclick="showSection('stats')">
                        <i class="fas fa-trophy"></i> Lvl <span id="lvl">1</span>
                        <span class="label-badge" id="xpBadge">0%</span>
                    </span>
                </div>
                <div class="label-container">
                    <span class="label label-accent" onclick="showProfileModal()">
                        <i class="fas fa-user"></i> <span id="headerUsername">User</span>
                    </span>
                </div>
                <button class="logout-btn" onclick="exportAllData()">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </header>

        <!-- Navigation - COMPACT VERSION -->
        <div class="nav-container">
            <nav>
                <button class="nav-btn active" onclick="showSection('play')">
                    <i class="fas fa-play-circle"></i> <span>Focus</span>
                </button>
                <button class="nav-btn" onclick="showSection('habits')">
                    <i class="fas fa-check-circle"></i> <span>Habits</span>
                </button>
                <button class="nav-btn" onclick="showSection('todo')">
                    <i class="fas fa-tasks"></i> <span>To-Do</span>
                </button>
                <button class="nav-btn" onclick="showSection('notes')">
                    <i class="fas fa-sticky-note"></i> <span>Notes</span>
                </button>
                <button class="nav-btn" onclick="showSection('calendar')">
                    <i class="fas fa-calendar"></i> <span>Calendar</span>
                </button>
                <button class="nav-btn" onclick="showSection('marketplace')">
                    <i class="fas fa-store"></i> <span>Market</span>
                </button>
                <button class="nav-btn" onclick="showSection('stats')">
                    <i class="fas fa-chart-bar"></i> <span>Stats</span>
                </button>
                <button class="nav-btn" onclick="showSection('quests')">
                    <i class="fas fa-flag"></i> <span>Quests</span>
                </button>
                <button class="nav-btn" onclick="showSection('achievements')">
                    <i class="fas fa-medal"></i> <span>Achieve</span>
                </button>
                <button class="nav-btn" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> <span>Settings</span>
                </button>
            </nav>
        </div>

        <!-- Sections -->
        <div class="sections-container">
            <!-- Focus Section -->
            <section id="play" class="active">
                <div class="section-header">
                    <h2 class="section-title">Focus Mode 🎯</h2>
                    <p class="section-subtitle">Maximize your productivity</p>
                </div>
                
                <div class="mode-switcher">
                    <button class="mode-btn active" onclick="switchMode('timer')">
                        <i class="fas fa-hourglass-half"></i> Timer
                    </button>
                    <button class="mode-btn" onclick="switchMode('stopwatch')">
                        <i class="fas fa-stopwatch"></i> Stopwatch
                    </button>
                    <button class="mode-btn" onclick="switchMode('pomodoro')">
                        <i class="fas fa-redo"></i> Pomodoro
                    </button>
                </div>
                
                <!-- Timer -->
                <div id="timerMode" class="timer-container">
                    <div class="orb-section">
                        <div class="orb-container" onclick="toggleOrbEffect()">
                            <div class="orb floating"></div>
                        </div>
                        <div class="time-display" id="timerDisplay">25:00</div>
                    </div>
                    
                    <div class="timer-inputs">
                        <input type="number" class="time-input" id="hours" placeholder="HH" min="0" max="23" value="0">
                        <div style="font-size: 1.8rem; color: var(--primary);">:</div>
                        <input type="number" class="time-input" id="minutes" placeholder="MM" min="0" max="59" value="25">
                        <div style="font-size: 1.8rem; color: var(--primary);">:</div>
                        <input type="number" class="time-input" id="seconds" placeholder="SS" min="0" max="59" value="0">
                    </div>
                    
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="setTimer(5)">5 min</button>
                        <button class="preset-btn" onclick="setTimer(15)">15 min</button>
                        <button class="preset-btn" onclick="setTimer(25)">25 min</button>
                        <button class="preset-btn" onclick="setTimer(45)">45 min</button>
                        <button class="preset-btn" onclick="setTimer(60)">60 min</button>
                    </div>
                </div>
                
                <!-- Stopwatch -->
                <div id="stopwatchMode" class="timer-container" style="display: none;">
                    <div class="orb-section">
                        <div class="orb-container">
                            <div class="orb"></div>
                        </div>
                        <div class="time-display" id="stopwatchDisplay">00:00:00</div>
                    </div>
                </div>
                
                <!-- Pomodoro -->
                <div id="pomodoroMode" class="timer-container" style="display: none;">
                    <div class="orb-section">
                        <div class="orb-container">
                            <div class="orb"></div>
                        </div>
                        <div class="time-display" id="pomodoroDisplay">25:00</div>
                    </div>
                    
                    <div class="pomodoro-settings">
                        <div style="display: flex; gap: 1rem; justify-content: center; margin: 1rem 0; flex-wrap: wrap;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">Focus (min)</label>
                                <input type="number" id="focusTime" value="25" min="5" max="60" class="time-input" style="width: 80px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">Break (min)</label>
                                <input type="number" id="breakTime" value="5" min="1" max="30" class="time-input" style="width: 80px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">Sessions</label>
                                <input type="number" id="pomodoroSessions" value="4" min="1" max="12" class="time-input" style="width: 80px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="control-buttons">
                    <button class="control-btn btn-start" onclick="startTimer()" id="startBtn">
                        <i class="fas fa-play"></i> START
                    </button>
                    <button class="control-btn btn-pause" onclick="pauseTimer()" id="pauseBtn" disabled>
                        <i class="fas fa-pause"></i> PAUSE
                    </button>
                    <button class="control-btn btn-reset" onclick="resetTimer()" id="resetBtn">
                        <i class="fas fa-redo"></i> RESET
                    </button>
                    <button class="control-btn btn-stopwatch" onclick="recordLap()" id="lapBtn" style="display: none;">
                        <i class="fas fa-flag"></i> LAP
                    </button>
                </div>
                
                <!-- Music -->
                <div class="focus-music">
                    <h3 style="text-align: center; margin-bottom: 1rem;">Focus Music 🎵</h3>
                    <div class="focus-music-grid" id="focusMusicGrid"></div>
                </div>

                <!-- App Restriction -->
                <div class="todo-container" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;"><i class="fas fa-lock"></i> App Restriction</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">Block distracting apps during focus sessions</p>
                    <div class="control-buttons">
                        <button class="control-btn btn-start" onclick="enableAppRestriction()">
                            <i class="fas fa-lock"></i> Enable Restriction
                        </button>
                        <button class="control-btn btn-reset" onclick="disableAppRestriction()">
                            <i class="fas fa-unlock"></i> Disable
                        </button>
                    </div>
                </div>
            </section>

            <!-- Habits Section -->
            <section id="habits">
                <div class="section-header">
                    <h2 class="section-title">Daily Habits 📝</h2>
                    <p class="section-subtitle">Build consistent productivity habits</p>
                </div>
                
                <div class="habits-container">
                    <div class="habit-grid" id="habitsGrid"></div>
                    
                    <div class="control-buttons" style="margin-top: 2rem;">
                        <button class="control-btn btn-start" onclick="showAddHabitModal()">
                            <i class="fas fa-plus"></i> Add New Habit
                        </button>
                        <button class="control-btn btn-reset" onclick="resetHabits()">
                            <i class="fas fa-redo"></i> Reset Week
                        </button>
                    </div>
                </div>
            </section>

            <!-- To-Do Section -->
            <section id="todo">
                <div class="section-header">
                    <h2 class="section-title">To-Do List ✅</h2>
                    <p class="section-subtitle">Organize your tasks and get things done</p>
                </div>
                
                <div class="todo-container">
                    <div class="todo-input-container">
                        <input type="text" class="todo-input" id="newTodo" placeholder="Add a new task..." onkeypress="handleTodoKeyPress(event)">
                        <select id="todoPriority" class="time-input" style="width: 140px;">
                            <option value="low">Low Priority</option>
                            <option value="medium" selected>Medium Priority</option>
                            <option value="high">High Priority</option>
                        </select>
                        <button class="control-btn btn-start" onclick="addTodo()" style="min-width: auto; padding: 0.8rem 1.5rem;">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    
                    <div class="todo-list" id="todoList"></div>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <div class="label-container">
                            <span class="label label-primary">
                                <i class="fas fa-tasks"></i> <span id="totalTasks">0</span> Total Tasks
                            </span>
                        </div>
                        <div class="label-container">
                            <span class="label label-success">
                                <i class="fas fa-check-circle"></i> <span id="completedTasks">0</span> Completed
                            </span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notes Section -->
            <section id="notes">
                <div class="section-header">
                    <h2 class="section-title">Quick Notes 📝</h2>
                    <p class="section-subtitle">Capture ideas, thoughts, and important information</p>
                </div>
                
                <div class="todo-container">
                    <div class="todo-input-container" style="flex-direction: column; gap: 1rem;">
                        <input type="text" class="todo-input" id="noteTitle" placeholder="Note title...">
                        <textarea class="todo-input" id="noteContent" placeholder="Start typing your note here..." rows="4"></textarea>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="control-btn btn-start" onclick="saveNote()">
                                <i class="fas fa-save"></i> Save Note
                            </button>
                            <button class="control-btn btn-reset" onclick="clearNoteForm()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="notes-container" id="notesContainer"></div>
            </section>

            <!-- Calendar Section -->
            <section id="calendar">
                <div class="section-header">
                    <h2 class="section-title">Productivity Calendar 📅</h2>
                    <p class="section-subtitle">Plan and track your productive days</p>
                </div>
                
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="prevMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="calendar-title" id="currentMonth">January 2024</div>
                        <button class="calendar-nav-btn" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
                
                <div id="dayDetails" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);" id="selectedDate">Selected Date</h3>
                    <div id="dayStats"></div>
                </div>
            </section>

            <!-- Marketplace -->
            <section id="marketplace">
                <div class="section-header">
                    <h2 class="section-title">Marketplace 🛍️</h2>
                    <p class="section-subtitle">Enhance your productivity experience</p>
                </div>
                
                <div class="market-filters">
                    <button class="filter-btn active" onclick="filterMarket('all')">All</button>
                    <button class="filter-btn" onclick="filterMarket('boost')">Boosts</button>
                    <button class="filter-btn" onclick="filterMarket('effects')">Effects</button>
                    <button class="filter-btn" onclick="filterMarket('themes')">Themes</button>
                    <button class="filter-btn" onclick="filterMarket('tools')">Tools</button>
                    <button class="filter-btn" onclick="filterMarket('premium')">Premium</button>
                </div>
                
                <div class="marketplace-grid" id="marketplaceGrid"></div>
            </section>

            <!-- Stats Section -->
            <section id="stats">
                <div class="section-header">
                    <h2 class="section-title">Your Statistics 📊</h2>
                    <p class="section-subtitle">Track your productivity journey in detail</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-coins"></i></div>
                        <div class="stat-value" id="totalCoins">0</div>
                        <div class="stat-label">Total Coins</div>
                        <div class="progress-bar" style="margin-top: 1rem;">
                            <div class="progress-fill" id="coinsProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-fire"></i></div>
                        <div class="stat-value" id="currentStreak">0</div>
                        <div class="stat-label">Current Streak</div>
                        <div class="progress-bar" style="margin-top: 1rem;">
                            <div class="progress-fill" id="streakProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="totalFocusTime">0h</div>
                        <div class="stat-label">Focus Time</div>
                        <div class="progress-bar" style="margin-top: 1rem;">
                            <div class="progress-fill" id="timeProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                        <div class="stat-value" id="activeDays">0</div>
                        <div class="stat-label">Active Days</div>
                        <div class="progress-bar" style="margin-top: 1rem;">
                            <div class="progress-fill" id="daysProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-title"><i class="fas fa-chart-line"></i> Weekly Focus Trend</div>
                        <div class="chart-wrapper">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title"><i class="fas fa-chart-pie"></i> Productivity Distribution</div>
                        <div class="chart-wrapper">
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quests Section -->
            <section id="quests">
                <div class="section-header">
                    <h2 class="section-title">Daily Quests 🏆</h2>
                    <p class="section-subtitle">Complete quests to earn rewards and level up!</p>
                </div>
                
                <div class="quests-container">
                    <div class="quest-grid" id="questsGrid"></div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <div class="label-container">
                            <span class="label label-warning">
                                <i class="fas fa-hourglass-half"></i> <span id="questsCompleted">0</span>/<span id="totalQuests">0</span> Quests Completed
                            </span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Achievements Section -->
            <section id="achievements">
                <div class="section-header">
                    <h2 class="section-title">Achievements 🏅</h2>
                    <p class="section-subtitle">Unlock rewards for your productivity milestones</p>
                </div>
                
                <div class="achievements-grid" id="achievementsGrid"></div>
            </section>

            <!-- Settings Section -->
            <section id="settings">
                <div class="section-header">
                    <h2 class="section-title">Settings ⚙️</h2>
                    <p class="section-subtitle">Customize your experience</p>
                </div>
                
                <div class="settings-grid">
                    <div class="setting-card">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary);"><i class="fas fa-volume-up"></i> Sound Settings</h3>
                        
                        <div class="setting-option">
                            <span>Sound Effects</span>
                            <label class="switch">
                                <input type="checkbox" id="soundEffects" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-option">
                            <span>Focus Music</span>
                            <label class="switch">
                                <input type="checkbox" id="focusMusic" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-option">
                            <span>Notification Sounds</span>
                            <label class="switch">
                                <input type="checkbox" id="notificationSounds" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-card">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary);"><i class="fas fa-bell"></i> Notification Settings</h3>
                        
                        <div class="setting-option">
                            <span>Focus Reminders</span>
                            <label class="switch">
                                <input type="checkbox" id="focusReminders" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-option">
                            <span>Daily Goals</span>
                            <label class="switch">
                                <input type="checkbox" id="dailyGoals" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-option">
                            <span>Quest Notifications</span>
                            <label class="switch">
                                <input type="checkbox" id="questNotifications" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-card">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary);"><i class="fas fa-clock"></i> Timer Settings</h3>
                        
                        <div class="setting-option">
                            <span>Default Timer (min)</span>
                            <input type="number" id="defaultTimer" value="25" min="5" max="120" style="width: 80px; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
                        </div>
                        
                        <div class="setting-option">
                            <span>Auto-start Breaks</span>
                            <label class="switch">
                                <input type="checkbox" id="autoBreak" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-card">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary);"><i class="fas fa-database"></i> Data Management</h3>
                        
                        <button class="control-btn btn-start" onclick="exportAllData()" style="width: 100%; margin-bottom: 1rem;">
                            <i class="fas fa-download"></i> Export All Data
                        </button>
                        
                        <button class="control-btn btn-pause" onclick="importData()" style="width: 100%; margin-bottom: 1rem;">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                        
                        <button class="control-btn btn-reset" onclick="resetAppData()" style="width: 100%;">
                            <i class="fas fa-trash"></i> Reset All Data
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary);"><i class="fas fa-user-cog"></i> Profile Settings</h2>
                
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div class="avatar-option selected" style="width: 100px; height: 100px; margin: 0 auto 1rem; font-size: 3rem; cursor: auto;" id="modalAvatar">
                        👨‍💻
                    </div>
                    <h3 id="modalUsername">Username</h3>
                    <p style="color: rgba(255,255,255,0.7);" id="modalLevel">Level 1 • 0 XP</p>
                </div>
                
                <div class="form-group">
                    <label for="editUsername"><i class="fas fa-user-edit"></i> Change Name</label>
                    <input type="text" id="editUsername" placeholder="Enter new name">
                </div>
                
                <div class="form-group">
                    <label for="editDailyQuote"><i class="fas fa-quote-right"></i> Change Daily Quote</label>
                    <textarea id="editDailyQuote" placeholder="Enter your motivation quote..." rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-smile"></i> Change Avatar</label>
                    <div class="avatar-selection" id="modalAvatarSelection"></div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="control-btn btn-start" onclick="updateProfile()" style="flex: 1;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button class="control-btn btn-reset" onclick="closeModal('profileModal')" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Habit Modal -->
        <div id="addHabitModal" class="modal">
            <div class="modal-content">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Habit</h2>
                
                <div class="form-group">
                    <label for="habitName"><i class="fas fa-heading"></i> Habit Name</label>
                    <input type="text" id="habitName" placeholder="e.g., Morning Meditation">
                </div>
                
                <div class="form-group">
                    <label for="habitDescription"><i class="fas fa-align-left"></i> Description</label>
                    <textarea id="habitDescription" placeholder="Describe your habit..." rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="habitFrequency"><i class="fas fa-calendar-check"></i> Frequency</label>
                    <select id="habitFrequency" class="time-input">
                        <option value="daily">Daily</option>
                        <option value="weekdays">Weekdays Only</option>
                        <option value="weekends">Weekends Only</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="habitCategory"><i class="fas fa-tag"></i> Category</label>
                    <select id="habitCategory" class="time-input">
                        <option value="health">Health & Wellness</option>
                        <option value="productivity">Productivity</option>
                        <option value="learning">Learning</option>
                        <option value="mindfulness">Mindfulness</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="control-btn btn-start" onclick="saveNewHabit()" style="flex: 1;">
                        <i class="fas fa-check"></i> Create Habit
                    </button>
                    <button class="control-btn btn-reset" onclick="closeModal('addHabitModal')" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- App Restriction Modal -->
        <div id="restrictionModal" class="modal restriction-modal">
            <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
                <h1 style="color: var(--primary); font-size: 2.5rem; margin-bottom: 1rem;">🚫 Focus Mode Active</h1>
                <div class="restriction-timer" id="restrictionTimer">25:00</div>
                <p class="restriction-message">
                    Stay focused! Distracting websites and apps are blocked.<br>
                    Complete your focus session to unlock access.
                </p>
                <div style="margin-top: 2rem;">
                    <button class="control-btn btn-reset" onclick="emergencyUnlock()" style="min-width: 200px;">
                        <i class="fas fa-unlock"></i> Emergency Unlock (Costs 50 coins)
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
            <i class="fas fa-bell"></i>
            <span id="notificationText">Ready to focus!</span>
        </div>

        <!-- Music Player -->
        <div class="music-player-active" id="musicPlayer">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <i class="fas fa-music" style="color: var(--primary);"></i>
                <span id="currentTrackName" style="font-weight: 600;">No track playing</span>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="control-btn btn-pause" onclick="pauseMusic()" style="padding: 0.5rem 1rem; min-width: auto;">
                    <i class="fas fa-pause"></i>
                </button>
                <button class="control-btn btn-reset" onclick="stopMusic()" style="padding: 0.5rem 1rem; min-width: auto;">
                    <i class="fas fa-stop"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== GLOBAL STATE =====
        let currentUser = null;
        let timerInterval = null;
        let stopwatchInterval = null;
        let pomodoroInterval = null;
        let timerMode = 'timer';
        let stopwatchTime = 0;
        let stopwatchRunning = false;
        let lapTimes = [];
        let currentTimer = {
            hours: 0,
            minutes: 25,
            seconds: 0,
            running: false,
            totalSeconds: 25 * 60
        };
        let pomodoroState = {
            isRunning: false,
            isBreak: false,
            focusTime: 25 * 60,
            breakTime: 5 * 60,
            sessions: 0,
            totalSessions: 4,
            currentTime: 25 * 60
        };
        let activeMusic = null;
        let activeMusicTrack = null;
        let preventLeave = false;
        let isRestrictionActive = false;
        let restrictionEndTime = null;
        let restrictionInterval = null;
        let currentDate = new Date();
        let weeklyChart = null;
        let productivityChart = null;

        // ===== AVATARS =====
        const avatars = [
            '👨‍💻', '👩‍💻', '🧑‍🎓', '👨‍🎓', '👩‍🎓', '🧙‍♂️', '🧙‍♀️', '🦸‍♂️', '🦸‍♀️', '🧚‍♂️', '🧚‍♀️',
            '🧜‍♂️', '🧜‍♀️', '🐱', '🐶', '🦊', '🐼', '🐯', '🦁', '🐮', '🐷', '🐸',
            '🐵', '🐔', '🐧', '🐦', '🦉', '🦄', '🐙', '🦋', '🐝', '🐢', '🦖',
            '🦕', '🐉', '🦚', '🦜', '🐬', '🦈', '🐋', '🐘', '🦒', '🦘', '🦏'
        ];

        // ===== MUSIC TRACKS =====
        const musicTracks = [
            {
                id: 1,
                name: "Lofi Study",
                icon: "fas fa-headphones",
                url: "https://cdn.pixabay.com/download/audio/2022/03/10/audio_8e7bdc6d1f.mp3",
                color: "#00D4FF"
            },
            {
                id: 2,
                name: "Rain Sounds",
                icon: "fas fa-cloud-rain",
                url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_0b8d1c7c3e.mp3",
                color: "#2196F3"
            },
            {
                id: 3,
                name: "Forest Ambience",
                icon: "fas fa-tree",
                url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_5c8d5c5c5c.mp3",
                color: "#4CAF50"
            },
            {
                id: 4,
                name: "White Noise",
                icon: "fas fa-volume-up",
                url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_9e8d7c6d5e.mp3",
                color: "#9C27B0"
            },
            {
                id: 5,
                name: "Ocean Waves",
                icon: "fas fa-water",
                url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_3e7d8c9d1f.mp3",
                color: "#00BCD4"
            },
            {
                id: 6,
                name: "Piano Focus",
                icon: "fas fa-music",
                url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_7d8c9e1f2g.mp3",
                color: "#E91E63"
            }
        ];

        // ===== DATABASE =====
        class ProductivityDatabase {
            constructor() {
                this.loadData();
            }
            
            loadData() {
                // Load all data with defaults
                this.user = JSON.parse(localStorage.getItem('focusArenaUser')) || null;
                this.sessions = JSON.parse(localStorage.getItem('focusArenaSessions')) || [];
                this.habits = JSON.parse(localStorage.getItem('focusArenaHabits')) || this.getDefaultHabits();
                this.todos = JSON.parse(localStorage.getItem('focusArenaTodos')) || [];
                this.notes = JSON.parse(localStorage.getItem('focusArenaNotes')) || [];
                this.achievements = JSON.parse(localStorage.getItem('focusArenaAchievements')) || this.getDefaultAchievements();
                this.quests = JSON.parse(localStorage.getItem('focusArenaQuests')) || this.getDailyQuests();
                this.settings = JSON.parse(localStorage.getItem('focusArenaSettings')) || this.getDefaultSettings();
                this.ownedItems = JSON.parse(localStorage.getItem('focusArenaOwnedItems')) || [1];
                this.calendar = JSON.parse(localStorage.getItem('focusArenaCalendar')) || {};
                this.stats = JSON.parse(localStorage.getItem('focusArenaStats')) || this.getDefaultStats();
                this.activeBoosts = JSON.parse(localStorage.getItem('focusArenaBoosts')) || {};
                
                if (!this.user) {
                    this.initializeDemoData();
                }
            }
            
            getDefaultHabits() {
                return [
                    {
                        id: 1,
                        name: "Morning Meditation",
                        description: "Start your day with 10 minutes of meditation",
                        category: "mindfulness",
                        frequency: "daily",
                        streak: 0,
                        completedToday: false,
                        totalCompletions: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: "Daily Planning",
                        description: "Plan your day in the morning",
                        category: "productivity",
                        frequency: "daily",
                        streak: 0,
                        completedToday: false,
                        totalCompletions: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: "Evening Review",
                        description: "Review your accomplishments at the end of the day",
                        category: "productivity",
                        frequency: "daily",
                        streak: 0,
                        completedToday: false,
                        totalCompletions: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
            }
            
            getDefaultAchievements() {
                return [
                    { id: 1, name: "First Focus", description: "Complete your first focus session", icon: "fas fa-baby", points: 10, unlocked: false, progress: 0, target: 1, type: "sessions" },
                    { id: 2, name: "Focus Novice", description: "Complete 10 focus sessions", icon: "fas fa-graduation-cap", points: 50, unlocked: false, progress: 0, target: 10, type: "sessions" },
                    { id: 3, name: "Time Master", description: "Accumulate 10 hours of focus", icon: "fas fa-clock", points: 100, unlocked: false, progress: 0, target: 36000, type: "time" },
                    { id: 4, name: "Week Warrior", description: "7-day focus streak", icon: "fas fa-fire", points: 75, unlocked: false, progress: 0, target: 7, type: "streak" },
                    { id: 5, name: "Task Master", description: "Complete 50 tasks", icon: "fas fa-tasks", points: 80, unlocked: false, progress: 0, target: 50, type: "tasks" },
                    { id: 6, name: "Habit Builder", description: "Maintain a habit for 30 days", icon: "fas fa-check-circle", points: 120, unlocked: false, progress: 0, target: 30, type: "habit" },
                    { id: 7, name: "Note Taker", description: "Create 20 notes", icon: "fas fa-sticky-note", points: 40, unlocked: false, progress: 0, target: 20, type: "notes" },
                    { id: 8, name: "Early Bird", description: "Focus before 8 AM", icon: "fas fa-sun", points: 30, unlocked: false, progress: 0, target: 1, type: "early" },
                    { id: 9, name: "Night Owl", description: "Focus after 10 PM", icon: "fas fa-moon", points: 30, unlocked: false, progress: 0, target: 1, type: "late" },
                    { id: 10, name: "Market Expert", description: "Purchase 10 items", icon: "fas fa-store", points: 60, unlocked: false, progress: 0, target: 10, type: "purchases" }
                ];
            }
            
            getDailyQuests() {
                const today = new Date().toDateString();
                const storedQuests = JSON.parse(localStorage.getItem('focusArenaDailyQuests')) || {};
                
                if (storedQuests.date !== today) {
                    const newQuests = [
                        { id: 1, name: "Morning Focus", description: "Complete a 25-minute focus session before noon", reward: 50, completed: false, type: "focus" },
                        { id: 2, name: "Task Completer", description: "Complete 5 to-do tasks", reward: 30, completed: false, type: "tasks", progress: 0, target: 5 },
                        { id: 3, name: "Habit Master", description: "Complete all daily habits", reward: 40, completed: false, type: "habits" },
                        { id: 4, name: "Note Keeper", description: "Create a new note", reward: 20, completed: false, type: "notes" },
                        { id: 5, name: "Evening Wind-down", description: "Complete a focus session after 6 PM", reward: 60, completed: false, type: "focus" }
                    ];
                    
                    storedQuests.date = today;
                    storedQuests.quests = newQuests;
                    localStorage.setItem('focusArenaDailyQuests', JSON.stringify(storedQuests));
                }
                
                return storedQuests.quests;
            }
            
            getDefaultSettings() {
                return {
                    soundEffects: true,
                    focusMusic: true,
                    notificationSounds: true,
                    focusReminders: true,
                    dailyGoals: true,
                    questNotifications: true,
                    defaultTimer: 25,
                    autoBreak: true,
                    theme: 'dark'
                };
            }
            
            getDefaultStats() {
                return {
                    totalFocusTime: 0,
                    totalSessions: 0,
                    currentStreak: 0,
                    longestStreak: 0,
                    totalTasks: 0,
                    completedTasks: 0,
                    totalNotes: 0,
                    achievementsUnlocked: 0,
                    dailyGoal: 120,
                    lastActiveDate: null
                };
            }
            
            initializeDemoData() {
                this.user = {
                    id: 'user_' + Date.now(),
                    username: "Productivity Master",
                    avatar: "👨‍💻",
                    dailyQuote: "Every minute of focus brings you closer to your goals!",
                    coins: 100,
                    level: 1,
                    xp: 0,
                    totalCoinsEarned: 100,
                    joinDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                this.saveAllData();
            }
            
            saveAllData() {
                try {
                    localStorage.setItem('focusArenaUser', JSON.stringify(this.user));
                    localStorage.setItem('focusArenaSessions', JSON.stringify(this.sessions));
                    localStorage.setItem('focusArenaHabits', JSON.stringify(this.habits));
                    localStorage.setItem('focusArenaTodos', JSON.stringify(this.todos));
                    localStorage.setItem('focusArenaNotes', JSON.stringify(this.notes));
                    localStorage.setItem('focusArenaAchievements', JSON.stringify(this.achievements));
                    localStorage.setItem('focusArenaSettings', JSON.stringify(this.settings));
                    localStorage.setItem('focusArenaOwnedItems', JSON.stringify(this.ownedItems));
                    localStorage.setItem('focusArenaCalendar', JSON.stringify(this.calendar));
                    localStorage.setItem('focusArenaStats', JSON.stringify(this.stats));
                    localStorage.setItem('focusArenaBoosts', JSON.stringify(this.activeBoosts));
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            }
            
            // User methods
            updateUser(data) {
                this.user = { ...this.user, ...data };
                this.saveAllData();
            }
            
            addCoins(amount) {
                this.user.coins += amount;
                this.user.totalCoinsEarned += amount;
                this.saveAllData();
                return this.user.coins;
            }
            
            addXP(amount) {
                this.user.xp += amount;
                const xpNeeded = this.user.level * 100;
                
                if (this.user.xp >= xpNeeded) {
                    this.user.level++;
                    this.user.coins += 100;
                    this.user.xp = this.user.xp - xpNeeded;
                    return { leveledUp: true, newLevel: this.user.level };
                }
                
                this.saveAllData();
                return { leveledUp: false };
            }
            
            // Session methods
            addSession(duration, type = 'focus') {
                const session = {
                    id: Date.now(),
                    duration,
                    type,
                    timestamp: new Date().toISOString(),
                    coinsEarned: Math.floor(duration / 60) * 5,
                    xpEarned: Math.floor(duration / 60) * 10
                };
                
                this.sessions.push(session);
                this.stats.totalFocusTime += duration;
                this.stats.totalSessions++;
                
                // Apply coin multiplier from boosts
                const coinMultiplier = this.activeBoosts.coinMultiplier || 1;
                const coins = Math.floor(session.coinsEarned * coinMultiplier);
                
                this.addCoins(coins);
                const xpResult = this.addXP(session.xpEarned);
                
                // Update streak
                const today = new Date().toDateString();
                if (this.stats.lastActiveDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (this.stats.lastActiveDate === yesterday.toDateString()) {
                        this.stats.currentStreak++;
                    } else {
                        this.stats.currentStreak = 1;
                    }
                    
                    this.stats.lastActiveDate = today;
                    this.addCoins(50); // Daily streak bonus
                }
                
                // Update calendar
                const dateKey = new Date().toISOString().split('T')[0];
                if (!this.calendar[dateKey]) {
                    this.calendar[dateKey] = { sessions: 0, focusTime: 0 };
                }
                this.calendar[dateKey].sessions++;
                this.calendar[dateKey].focusTime += duration;
                
                // Update achievements
                this.updateAchievements('sessions', 1);
                this.updateAchievements('time', duration);
                
                this.saveAllData();
                
                return {
                    session,
                    coins,
                    xpResult,
                    streak: this.stats.currentStreak
                };
            }
            
            // Achievement methods
            updateAchievements(type, value) {
                let unlockedAchievements = [];
                
                this.achievements.forEach(achievement => {
                    if (achievement.unlocked) return;
                    
                    if (achievement.type === type) {
                        achievement.progress += value;
                        
                        if (achievement.progress >= achievement.target) {
                            achievement.unlocked = true;
                            unlockedAchievements.push(achievement);
                            
                            // Reward for achievement
                            this.addCoins(achievement.points * 10);
                            this.stats.achievementsUnlocked++;
                        }
                    }
                });
                
                if (unlockedAchievements.length > 0) {
                    this.saveAllData();
                }
                
                return unlockedAchievements;
            }
            
            // Habit methods
            getHabits() {
                return this.habits;
            }
            
            addHabit(habit) {
                const newHabit = {
                    id: Date.now(),
                    ...habit,
                    streak: 0,
                    completedToday: false,
                    totalCompletions: 0,
                    createdAt: new Date().toISOString()
                };
                
                this.habits.push(newHabit);
                this.saveAllData();
                return newHabit;
            }
            
            completeHabit(id) {
                const habit = this.habits.find(h => h.id === id);
                if (!habit) return null;
                
                const today = new Date().toDateString();
                const lastCompleted = habit.lastCompleted ? new Date(habit.lastCompleted).toDateString() : null;
                
                if (!habit.completedToday) {
                    habit.completedToday = true;
                    habit.totalCompletions++;
                    habit.lastCompleted = new Date().toISOString();
                    
                    // Update streak
                    if (lastCompleted === yesterdayDateString()) {
                        habit.streak++;
                    } else {
                        habit.streak = 1;
                    }
                    
                    // Reward
                    const coins = 10 * (habit.streak > 7 ? 2 : 1); // Double coins after 7-day streak
                    this.addCoins(coins);
                    
                    // Update quests
                    this.updateQuests('habits');
                    
                    this.saveAllData();
                    return { habit, coins, streak: habit.streak };
                }
                
                return null;
            }
            
            resetHabits() {
                this.habits.forEach(habit => {
                    habit.completedToday = false;
                });
                this.saveAllData();
            }
            
            // Todo methods
            getTodos() {
                return this.todos;
            }
            
            addTodo(todo) {
                const newTodo = {
                    id: Date.now(),
                    ...todo,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                this.todos.push(newTodo);
                this.stats.totalTasks++;
                this.saveAllData();
                return newTodo;
            }
            
            toggleTodo(id) {
                const todo = this.todos.find(t => t.id === id);
                if (todo) {
                    todo.completed = !todo.completed;
                    
                    if (todo.completed) {
                        this.stats.completedTasks++;
                        this.updateQuests('tasks');
                    } else {
                        this.stats.completedTasks--;
                    }
                    
                    this.saveAllData();
                }
                return todo;
            }
            
            deleteTodo(id) {
                const todoIndex = this.todos.findIndex(t => t.id === id);
                if (todoIndex !== -1) {
                    const todo = this.todos[todoIndex];
                    if (todo.completed) {
                        this.stats.completedTasks--;
                    }
                    this.stats.totalTasks--;
                    this.todos.splice(todoIndex, 1);
                    this.saveAllData();
                    return true;
                }
                return false;
            }
            
            // Note methods
            getNotes() {
                return this.notes;
            }
            
            addNote(note) {
                const newNote = {
                    id: Date.now(),
                    ...note,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                this.notes.push(newNote);
                this.stats.totalNotes++;
                this.updateQuests('notes');
                this.saveAllData();
                return newNote;
            }
            
            deleteNote(id) {
                const noteIndex = this.notes.findIndex(n => n.id === id);
                if (noteIndex !== -1) {
                    this.notes.splice(noteIndex, 1);
                    this.stats.totalNotes--;
                    this.saveAllData();
                    return true;
                }
                return false;
            }
            
            // Quest methods
            getQuests() {
                return this.quests;
            }
            
            updateQuests(type, value = 1) {
                let completedQuests = [];
                
                this.quests.forEach(quest => {
                    if (quest.completed) return;
                    
                    if (quest.type === type) {
                        if (quest.progress !== undefined) {
                            quest.progress += value;
                            if (quest.progress >= quest.target) {
                                quest.completed = true;
                                completedQuests.push(quest);
                            }
                        } else {
                            quest.completed = true;
                            completedQuests.push(quest);
                        }
                    }
                });
                
                if (completedQuests.length > 0) {
                    completedQuests.forEach(quest => {
                        this.addCoins(quest.reward);
                    });
                    this.saveAllData();
                }
                
                return completedQuests;
            }
            
            resetQuests() {
                const today = new Date().toDateString();
                const storedQuests = JSON.parse(localStorage.getItem('focusArenaDailyQuests')) || {};
                
                if (storedQuests.date !== today) {
                    this.quests = this.getDailyQuests();
                    this.saveAllData();
                }
            }
            
            // Marketplace methods
            purchaseItem(itemId) {
                const item = marketItems.find(i => i.id === itemId);
                if (!item) throw new Error('Item not found');
                
                if (this.user.coins < item.price) {
                    throw new Error('Not enough coins');
                }
                
                if (this.ownedItems.includes(itemId)) {
                    throw new Error('Already owned');
                }
                
                this.user.coins -= item.price;
                this.ownedItems.push(itemId);
                
                // Apply item effect
                if (item.applyEffect) {
                    item.applyEffect(true, this);
                }
                
                // If it's a boost, activate it
                if (item.type === 'boost') {
                    this.activateBoost(item);
                }
                
                // Update achievement for purchases
                this.updateAchievements('purchases', 1);
                
                this.saveAllData();
                return true;
            }
            
            activateBoost(item) {
                const duration = item.duration || 3600000; // 1 hour default
                this.activeBoosts[item.boostType] = {
                    value: item.value,
                    expires: Date.now() + duration
                };
                
                // Set timeout to remove boost
                setTimeout(() => {
                    if (this.activeBoosts[item.boostType]) {
                        delete this.activeBoosts[item.boostType];
                        this.saveAllData();
                        showNotification(`${item.name} boost has expired!`);
                    }
                }, duration);
            }
            
            // Settings methods
            updateSettings(newSettings) {
                this.settings = { ...this.settings, ...newSettings };
                this.saveAllData();
                return this.settings;
            }
            
            // Export/Import
            exportData() {
                return {
                    user: this.user,
                    sessions: this.sessions,
                    habits: this.habits,
                    todos: this.todos,
                    notes: this.notes,
                    achievements: this.achievements,
                    settings: this.settings,
                    ownedItems: this.ownedItems,
                    calendar: this.calendar,
                    stats: this.stats,
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
            }
            
            importData(data) {
                if (!data.user) throw new Error('Invalid data format');
                
                this.user = data.user;
                this.sessions = data.sessions || [];
                this.habits = data.habits || this.getDefaultHabits();
                this.todos = data.todos || [];
                this.notes = data.notes || [];
                this.achievements = data.achievements || this.getDefaultAchievements();
                this.settings = data.settings || this.getDefaultSettings();
                this.ownedItems = data.ownedItems || [1];
                this.calendar = data.calendar || {};
                this.stats = data.stats || this.getDefaultStats();
                
                this.saveAllData();
                return true;
            }
            
            resetData() {
                localStorage.clear();
                this.loadData();
            }
        }

        // Helper functions
        function yesterdayDateString() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.toDateString();
        }

        // ===== MARKET ITEMS =====
        const marketItems = [
            // Boosts
            {
                id: 101,
                name: "Coin Boost",
                description: "Earn 2x coins for 1 hour",
                icon: "fas fa-coins",
                price: 200,
                type: "boost",
                category: "boost",
                rarity: "uncommon",
                boostType: "coinMultiplier",
                value: 2,
                duration: 3600000,
                applyEffect: (enable, db) => {
                    if (enable) {
                        db.activateBoost(marketItems.find(i => i.id === 101));
                        showNotification('Coin boost activated! Earn 2x coins for 1 hour!');
                    }
                }
            },
            {
                id: 102,
                name: "XP Boost",
                description: "Earn 1.5x XP for 2 hours",
                icon: "fas fa-rocket",
                price: 300,
                type: "boost",
                category: "boost",
                rarity: "rare",
                boostType: "xpMultiplier",
                value: 1.5,
                duration: 7200000,
                applyEffect: (enable, db) => {
                    if (enable) {
                        db.activateBoost(marketItems.find(i => i.id === 102));
                        showNotification('XP boost activated! Level up faster!');
                    }
                }
            },
            {
                id: 103,
                name: "Focus Boost",
                description: "25% faster focus session completion",
                icon: "fas fa-bolt",
                price: 400,
                type: "boost",
                category: "boost",
                rarity: "epic",
                boostType: "focusSpeed",
                value: 0.75,
                duration: 3600000,
                applyEffect: (enable, db) => {
                    if (enable) {
                        db.activateBoost(marketItems.find(i => i.id === 103));
                        showNotification('Focus boost activated! Sessions complete faster!');
                    }
                }
            },
            {
                id: 104,
                name: "Streak Protector",
                description: "Protect your streak for 24 hours",
                icon: "fas fa-shield-alt",
                price: 150,
                type: "boost",
                category: "boost",
                rarity: "common",
                boostType: "streakProtector",
                value: 1,
                duration: 86400000,
                applyEffect: (enable, db) => {
                    if (enable) {
                        db.activateBoost(marketItems.find(i => i.id === 104));
                        showNotification('Streak protected! Your streak is safe for 24 hours!');
                    }
                }
            },
            
            // Effects
            {
                id: 201,
                name: "Particle Effects",
                description: "Beautiful particle animations during focus",
                icon: "fas fa-sparkles",
                price: 150,
                type: "effect",
                category: "effects",
                rarity: "uncommon",
                applyEffect: (enable) => {
                    if (enable) {
                        document.body.classList.add('particles-enabled');
                        showNotification('Particle effects enabled! ✨');
                    } else {
                        document.body.classList.remove('particles-enabled');
                    }
                }
            },
            {
                id: 202,
                name: "Confetti Celebration",
                description: "Confetti when completing sessions",
                icon: "fas fa-birthday-cake",
                price: 100,
                type: "effect",
                category: "effects",
                rarity: "common",
                applyEffect: (enable) => {
                    if (enable) {
                        window.confettiEnabled = true;
                        showNotification('Confetti celebrations enabled! 🎉');
                    } else {
                        window.confettiEnabled = false;
                    }
                }
            },
            {
                id: 203,
                name: "Orb Glow",
                description: "Enhanced orb glow effects",
                icon: "fas fa-circle",
                price: 200,
                type: "effect",
                category: "effects",
                rarity: "rare",
                applyEffect: (enable) => {
                    const orb = document.querySelector('.orb');
                    if (enable) {
                        orb.style.boxShadow = 'inset 0 0 80px rgba(255, 255, 255, 0.2), 0 0 120px rgba(0, 212, 255, 0.8), 0 0 180px rgba(157, 78, 221, 0.6)';
                        showNotification('Orb glow enhanced! 💫');
                    } else {
                        orb.style.boxShadow = '';
                    }
                }
            },
            
            // Themes
            {
                id: 301,
                name: "Dark Theme",
                description: "Default dark theme",
                icon: "fas fa-moon",
                price: 0,
                type: "theme",
                category: "themes",
                rarity: "common",
                applyEffect: (enable) => {
                    if (enable) {
                        document.documentElement.style.setProperty('--primary', '#00D4FF');
                        document.documentElement.style.setProperty('--dark', '#121212');
                        showNotification('Dark theme applied! 🌙');
                    }
                }
            },
            {
                id: 302,
                name: "Light Theme",
                description: "Clean light theme",
                icon: "fas fa-sun",
                price: 100,
                type: "theme",
                category: "themes",
                rarity: "common",
                applyEffect: (enable) => {
                    if (enable) {
                        document.documentElement.style.setProperty('--primary', '#2563EB');
                        document.documentElement.style.setProperty('--dark', '#F8FAFC');
                        document.documentElement.style.setProperty('--light', '#1E293B');
                        showNotification('Light theme applied! ☀️');
                    }
                }
            },
            {
                id: 303,
                name: "Ocean Theme",
                description: "Calm ocean colors",
                icon: "fas fa-water",
                price: 200,
                type: "theme",
                category: "themes",
                rarity: "uncommon",
                applyEffect: (enable) => {
                    if (enable) {
                        document.documentElement.style.setProperty('--primary', '#06B6D4');
                        document.documentElement.style.setProperty('--dark', '#0F172A');
                        showNotification('Ocean theme applied! 🌊');
                    }
                }
            },
            {
                id: 304,
                name: "Forest Theme",
                description: "Nature inspired theme",
                icon: "fas fa-tree",
                price: 200,
                type: "theme",
                category: "themes",
                rarity: "uncommon",
                applyEffect: (enable) => {
                    if (enable) {
                        document.documentElement.style.setProperty('--primary', '#10B981');
                        document.documentElement.style.setProperty('--dark', '#064E3B');
                        showNotification('Forest theme applied! 🌳');
                    }
                }
            },
            {
                id: 305,
                name: "Sunset Theme",
                description: "Warm sunset colors",
                icon: "fas fa-sunset",
                price: 300,
                type: "theme",
                category: "themes",
                rarity: "rare",
                applyEffect: (enable) => {
                    if (enable) {
                        document.documentElement.style.setProperty('--primary', '#F97316');
                        document.documentElement.style.setProperty('--dark', '#1E293B');
                        showNotification('Sunset theme applied! 🌇');
                    }
                }
            },
            
            // Tools
            {
                id: 401,
                name: "Advanced Stats",
                description: "Detailed productivity analytics",
                icon: "fas fa-chart-line",
                price: 300,
                type: "tool",
                category: "tools",
                rarity: "rare",
                applyEffect: (enable) => {
                    if (enable) {
                        showNotification('Advanced stats unlocked! Access detailed analytics. 📈');
                    }
                }
            },
            {
                id: 402,
                name: "Habit Templates",
                description: "Pre-made habit templates",
                icon: "fas fa-clipboard-list",
                price: 200,
                type: "tool",
                category: "tools",
                rarity: "uncommon",
                applyEffect: (enable) => {
                    if (enable) {
                        showNotification('Habit templates unlocked! Quickly add proven habits. 📋');
                    }
                }
            },
            {
                id: 403,
                name: "Focus Music Pack",
                description: "Premium focus music collection",
                icon: "fas fa-music",
                price: 250,
                type: "tool",
                category: "tools",
                rarity: "rare",
                applyEffect: (enable) => {
                    if (enable) {
                        showNotification('Premium music unlocked! Enjoy curated focus tracks. 🎵');
                    }
                }
            },
            
            // Premium
            {
                id: 501,
                name: "Unlimited Themes",
                description: "Access all themes",
                icon: "fas fa-palette",
                price: 1000,
                type: "premium",
                category: "premium",
                rarity: "legendary",
                applyEffect: (enable, db) => {
                    if (enable) {
                        // Unlock all themes
                        [302, 303, 304, 305].forEach(itemId => {
                            if (!db.ownedItems.includes(itemId)) {
                                db.ownedItems.push(itemId);
                            }
                        });
                        showNotification('All themes unlocked! 🎨');
                    }
                }
            },
            {
                id: 502,
                name: "All Effects Pack",
                description: "All visual effects",
                icon: "fas fa-magic",
                price: 800,
                type: "premium",
                category: "premium",
                rarity: "epic",
                applyEffect: (enable, db) => {
                    if (enable) {
                        // Unlock all effects
                        [201, 202, 203].forEach(itemId => {
                            if (!db.ownedItems.includes(itemId)) {
                                db.ownedItems.push(itemId);
                            }
                        });
                        showNotification('All visual effects unlocked! ✨');
                    }
                }
            },
            {
                id: 503,
                name: "Pro Features",
                description: "All premium features + exclusive content",
                icon: "fas fa-crown",
                price: 2000,
                type: "premium",
                category: "premium",
                rarity: "legendary",
                applyEffect: (enable, db) => {
                    if (enable) {
                        // Unlock everything
                        marketItems.forEach(item => {
                            if (item.id !== 1 && !db.ownedItems.includes(item.id)) {
                                db.ownedItems.push(item.id);
                            }
                        });
                        showNotification('All premium features unlocked! Welcome to PRO! 👑');
                    }
                }
            }
        ];

        // ===== INITIALIZE DATABASE =====
        const db = new ProductivityDatabase();

        // ===== INITIALIZE APP =====
        window.addEventListener('DOMContentLoaded', () => {
            if (db.user) {
                currentUser = db.user;
                document.getElementById('profileSetup').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                initializeApp();
            } else {
                initProfileSetup();
            }
        });

        // ===== PROFILE SETUP =====
        function initProfileSetup() {
            const avatarSelection = document.getElementById('avatarSelection');
            avatars.slice(0, 24).forEach((avatar, i) => {
                const option = document.createElement('div');
                option.className = 'avatar-option' + (i === 0 ? ' selected' : '');
                option.textContent = avatar;
                option.onclick = () => {
                    document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                };
                avatarSelection.appendChild(option);
            });
            
            document.getElementById('profileForm').onsubmit = (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const avatar = document.querySelector('.avatar-option.selected').textContent;
                const focusGoal = parseInt(document.getElementById('focusGoal').value);
                const dailyQuote = document.getElementById('dailyQuote').value;
                
                if (!username.trim()) {
                    showNotification('Please enter your name');
                    return;
                }
                
                db.user = {
                    id: 'user_' + Date.now(),
                    username,
                    avatar,
                    dailyQuote: dailyQuote || "Every minute of focus brings you closer to your goals!",
                    coins: 100,
                    level: 1,
                    xp: 0,
                    totalCoinsEarned: 100,
                    joinDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                db.stats.dailyGoal = focusGoal;
                db.saveAllData();
                
                document.getElementById('profileSetup').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                initializeApp();
                showNotification(`Welcome to Focus Arena, ${username}! 🚀`);
            };
        }

        // ===== APP INITIALIZATION =====
        function initializeApp() {
            currentUser = db.user;
            
            // Update UI
            updateUserStats();
            loadHabits();
            loadTodos();
            loadNotes();
            updateCalendar();
            loadFocusMusic();
            loadSettings();
            renderMarketplace();
            renderQuests();
            renderAchievements();
            updateCharts();
            
            // Set initial timer
            setTimer(db.settings.defaultTimer || 25);
            
            // Setup event listeners
            setupLeavePrevention();
            
            // Check for active boosts
            checkActiveBoosts();
            
            // Reset daily quests if needed
            db.resetQuests();
            
            // Auto-save every 30 seconds
            setInterval(() => db.saveAllData(), 30000);
            
            // Show daily motivation
            setTimeout(() => {
                showNotification(currentUser.dailyQuote || "Ready to focus! Let's make today productive! 💪");
            }, 1000);
        }

        // ===== TIMER FUNCTIONS =====
        function switchMode(mode) {
            timerMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide modes
            document.getElementById('timerMode').style.display = mode === 'timer' ? 'block' : 'none';
            document.getElementById('stopwatchMode').style.display = mode === 'stopwatch' ? 'block' : 'none';
            document.getElementById('pomodoroMode').style.display = mode === 'pomodoro' ? 'block' : 'none';
            
            // Update buttons
            document.getElementById('lapBtn').style.display = mode === 'stopwatch' ? 'flex' : 'none';
            
            resetTimer();
        }

        function setTimer(minutes) {
            currentTimer.minutes = minutes;
            currentTimer.seconds = 0;
            currentTimer.totalSeconds = minutes * 60;
            
            document.getElementById('minutes').value = minutes;
            updateTimerDisplay();
        }

        function startTimer() {
            if (timerMode === 'timer') {
                startFocusTimer();
            } else if (timerMode === 'stopwatch') {
                startStopwatch();
            } else if (timerMode === 'pomodoro') {
                startPomodoro();
            }
        }

        function pauseTimer() {
            if (timerMode === 'timer') {
                pauseFocusTimer();
            } else if (timerMode === 'stopwatch') {
                pauseStopwatch();
            } else if (timerMode === 'pomodoro') {
                pausePomodoro();
            }
        }

        function resetTimer() {
            if (timerMode === 'timer') {
                resetFocusTimer();
            } else if (timerMode === 'stopwatch') {
                resetStopwatch();
            } else if (timerMode === 'pomodoro') {
                resetPomodoro();
            }
        }

        // Focus Timer
        function startFocusTimer() {
            if (currentTimer.running) return;
            
            const hours = parseInt(document.getElementById('hours').value) || 0;
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            
            if (hours === 0 && minutes === 0 && seconds === 0) {
                showNotification('Please set a timer first!');
                return;
            }
            
            currentTimer = {
                hours,
                minutes,
                seconds,
                running: true,
                totalSeconds: hours * 3600 + minutes * 60 + seconds
            };
            
            updateTimerDisplay();
            
            // Apply focus speed boost if active
            const focusBoost = db.activeBoosts.focusSpeed;
            const intervalMultiplier = focusBoost ? focusBoost.value : 1;
            
            timerInterval = setInterval(() => {
                currentTimer.totalSeconds -= intervalMultiplier;
                
                if (currentTimer.totalSeconds <= 0) {
                    completeTimer();
                    return;
                }
                
                updateTimerDisplay();
            }, 1000);
            
            updateTimerButtons(true);
            showNotification('Focus timer started! Stay productive! ⏰');
            
            // Start playing focus music if enabled
            if (db.settings.focusMusic && !activeMusic) {
                playMusic(musicTracks[0]);
            }
        }

        function completeTimer() {
            clearInterval(timerInterval);
            currentTimer.running = false;
            updateTimerButtons(false);
            
            const duration = currentTimer.hours * 3600 + currentTimer.minutes * 60 + currentTimer.seconds;
            const result = db.addSession(duration);
            
            updateUserStats();
            updateCalendar();
            updateCharts();
            
            showNotification(`🎊 Session Complete! +${result.coins} coins | +${result.session.xpEarned} XP`);
            
            if (result.xpResult.leveledUp) {
                showNotification(`🎉 Level Up! You're now level ${result.xpResult.newLevel}!`);
                triggerConfetti();
            }
            
            // Trigger confetti if enabled
            if (window.confettiEnabled) {
                triggerConfetti();
            }
            
            // Play completion sound
            if (db.settings.soundEffects) {
                playCompletionSound();
            }
            
            // Update quests
            const completedQuests = db.updateQuests('focus');
            completedQuests.forEach(quest => {
                showNotification(`🏆 Quest Complete: ${quest.name}! +${quest.reward} coins`);
            });
            
            // Reset timer
            const hours = parseInt(document.getElementById('hours').value) || 0;
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            currentTimer.totalSeconds = hours * 3600 + minutes * 60 + seconds;
            updateTimerDisplay();
        }

        function pauseFocusTimer() {
            if (!currentTimer.running) return;
            
            clearInterval(timerInterval);
            currentTimer.running = false;
            updateTimerButtons(false);
            showNotification('Timer paused');
        }

        function resetFocusTimer() {
            clearInterval(timerInterval);
            currentTimer.running = false;
            const hours = parseInt(document.getElementById('hours').value) || 0;
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            currentTimer.totalSeconds = hours * 3600 + minutes * 60 + seconds;
            updateTimerDisplay();
            updateTimerButtons(false);
        }

        // Stopwatch
        function startStopwatch() {
            if (stopwatchRunning) return;
            
            stopwatchRunning = true;
            stopwatchInterval = setInterval(() => {
                stopwatchTime++;
                updateStopwatchDisplay();
            }, 1000);
            
            updateTimerButtons(true);
            showNotification('Stopwatch started! ⏱️');
        }

        function pauseStopwatch() {
            if (!stopwatchRunning) return;
            
            clearInterval(stopwatchInterval);
            stopwatchRunning = false;
            updateTimerButtons(false);
            showNotification('Stopwatch paused');
        }

        function resetStopwatch() {
            clearInterval(stopwatchInterval);
            stopwatchRunning = false;
            stopwatchTime = 0;
            lapTimes = [];
            updateStopwatchDisplay();
            document.getElementById('lapTimes').innerHTML = '';
            document.getElementById('lapCount').innerHTML = '<i class="fas fa-flag"></i> Laps: 0';
            updateTimerButtons(false);
            showNotification('Stopwatch reset');
        }

        function recordLap() {
            if (!stopwatchRunning) return;
            
            lapTimes.push({
                time: stopwatchTime,
                display: formatTime(stopwatchTime)
            });
            
            const lapTimesElement = document.getElementById('lapTimes');
            const lapNumber = lapTimes.length;
            
            const lapElement = document.createElement('div');
            lapElement.className = 'label-container';
            lapElement.style.margin = '0.5rem 0';
            lapElement.innerHTML = `
                <span class="label label-primary">
                    <i class="fas fa-flag"></i> Lap ${lapNumber}: ${formatTime(stopwatchTime)}
                </span>
            `;
            
            lapTimesElement.appendChild(lapElement);
            document.getElementById('lapCount').innerHTML = `<i class="fas fa-flag"></i> Laps: ${lapTimes.length}`;
            
            showNotification(`Lap ${lapNumber} recorded! 🏁`);
        }

        // Pomodoro
        function startPomodoro() {
            if (pomodoroState.isRunning) return;
            
            pomodoroState.isRunning = true;
            pomodoroState.focusTime = parseInt(document.getElementById('focusTime').value) * 60;
            pomodoroState.breakTime = parseInt(document.getElementById('breakTime').value) * 60;
            pomodoroState.totalSessions = parseInt(document.getElementById('pomodoroSessions').value);
            pomodoroState.currentTime = pomodoroState.isBreak ? pomodoroState.breakTime : pomodoroState.focusTime;
            
            updatePomodoroDisplay();
            
            pomodoroInterval = setInterval(() => {
                pomodoroState.currentTime--;
                
                if (pomodoroState.currentTime <= 0) {
                    pomodoroState.isBreak = !pomodoroState.isBreak;
                    
                    if (!pomodoroState.isBreak) {
                        pomodoroState.sessions++;
                        if (pomodoroState.sessions >= pomodoroState.totalSessions) {
                            completePomodoro();
                            return;
                        }
                    }
                    
                    pomodoroState.currentTime = pomodoroState.isBreak ? pomodoroState.breakTime : pomodoroState.focusTime;
                    
                    showNotification(pomodoroState.isBreak ? 'Break time! ☕' : 'Focus time! 🎯');
                }
                
                updatePomodoroDisplay();
            }, 1000);
            
            updateTimerButtons(true);
            showNotification(pomodoroState.isBreak ? 'Break started' : 'Pomodoro started! 🍅');
        }

        function completePomodoro() {
            clearInterval(pomodoroInterval);
            pomodoroState.isRunning = false;
            updateTimerButtons(false);
            
            const totalTime = pomodoroState.sessions * pomodoroState.focusTime;
            const result = db.addSession(totalTime, 'pomodoro');
            
            updateUserStats();
            
            showNotification(`🎉 Pomodoro Complete! ${pomodoroState.sessions} sessions | +${result.coins} coins`);
            triggerConfetti();
        }

        function pausePomodoro() {
            if (!pomodoroState.isRunning) return;
            
            clearInterval(pomodoroInterval);
            pomodoroState.isRunning = false;
            updateTimerButtons(false);
            showNotification('Pomodoro paused');
        }

        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            pomodoroState = {
                isRunning: false,
                isBreak: false,
                focusTime: 25 * 60,
                breakTime: 5 * 60,
                sessions: 0,
                totalSessions: 4,
                currentTime: 25 * 60
            };
            updatePomodoroDisplay();
            updateTimerButtons(false);
        }

        // Display Updates
        function updateTimerDisplay() {
            const hours = Math.floor(currentTimer.totalSeconds / 3600);
            const minutes = Math.floor((currentTimer.totalSeconds % 3600) / 60);
            const seconds = currentTimer.totalSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateStopwatchDisplay() {
            const hours = Math.floor(stopwatchTime / 3600);
            const minutes = Math.floor((stopwatchTime % 3600) / 60);
            const seconds = stopwatchTime % 60;
            document.getElementById('stopwatchDisplay').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroState.currentTime / 60);
            const seconds = pomodoroState.currentTime % 60;
            document.getElementById('pomodoroDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerButtons(running) {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (running) {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                preventLeave = true;
            } else {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                preventLeave = false;
            }
        }

        // ===== HABITS =====
        function loadHabits() {
            const habitsGrid = document.getElementById('habitsGrid');
            if (!habitsGrid) return;
            
            const habits = db.getHabits();
            
            if (habits.length === 0) {
                habitsGrid.innerHTML = `
                    <div style="text-align: center; padding: 2rem; grid-column: 1 / -1;">
                        <div class="label-container">
                            <span class="label label-secondary">
                                <i class="fas fa-clipboard-list"></i> No habits yet
                            </span>
                        </div>
                        <p style="text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.5);">
                            Create your first habit to start tracking!
                        </p>
                        <button class="control-btn btn-start" onclick="showAddHabitModal()" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Add First Habit
                        </button>
                    </div>
                `;
                return;
            }
            
            habitsGrid.innerHTML = '';
            
            habits.forEach(habit => {
                const completionPercentage = habit.totalCompletions > 0 ? Math.min(100, (habit.streak / 30) * 100) : 0;
                
                const habitCard = document.createElement('div');
                habitCard.className = 'habit-card';
                habitCard.innerHTML = `
                    <div class="habit-header">
                        <div class="habit-name">${habit.name}</div>
                        <div class="habit-streak">
                            <i class="fas fa-fire"></i> ${habit.streak} days
                        </div>
                    </div>
                    <div class="habit-description">${habit.description}</div>
                    <div class="habit-progress">
                        <div class="progress-text">
                            <span>${habit.totalCompletions} completions</span>
                            <span>${completionPercentage.toFixed(0)}% to goal</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${completionPercentage}%"></div>
                        </div>
                    </div>
                    <div class="habit-check">
                        <button class="habit-check-btn ${habit.completedToday ? 'checked' : ''}" 
                                onclick="completeHabit(${habit.id})"
                                ${habit.completedToday ? 'disabled' : ''}>
                            ${habit.completedToday ? '✓ Completed Today' : 'Mark Complete'}
                        </button>
                        <span style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">
                            ${habit.category} • ${habit.frequency}
                        </span>
                    </div>
                `;
                
                habitsGrid.appendChild(habitCard);
            });
        }

        function showAddHabitModal() {
            document.getElementById('addHabitModal').style.display = 'flex';
        }

        function saveNewHabit() {
            const name = document.getElementById('habitName').value;
            const description = document.getElementById('habitDescription').value;
            const frequency = document.getElementById('habitFrequency').value;
            const category = document.getElementById('habitCategory').value;
            
            if (!name.trim()) {
                showNotification('Please enter a habit name');
                return;
            }
            
            const habit = {
                name,
                description,
                frequency,
                category
            };
            
            db.addHabit(habit);
            loadHabits();
            closeModal('addHabitModal');
            
            // Clear form
            document.getElementById('habitName').value = '';
            document.getElementById('habitDescription').value = '';
            
            showNotification('New habit added! 📝');
        }

        function completeHabit(id) {
            const result = db.completeHabit(id);
            if (result) {
                loadHabits();
                updateUserStats();
                showNotification(`Habit completed! +${result.coins} coins 🔥`);
                
                // Update quests
                const completedQuests = db.updateQuests('habits');
                completedQuests.forEach(quest => {
                    showNotification(`🏆 Quest Complete: ${quest.name}! +${quest.reward} coins`);
                });
            }
        }

        function resetHabits() {
            db.resetHabits();
            loadHabits();
            showNotification('Habits reset for the new week! 📅');
        }

        // ===== TO-DO LIST =====
        function loadTodos() {
            const todoList = document.getElementById('todoList');
            if (!todoList) return;
            
            const todos = db.getTodos();
            
            if (todos.length === 0) {
                todoList.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="label-container">
                            <span class="label label-secondary">
                                <i class="fas fa-tasks"></i> No tasks yet
                            </span>
                        </div>
                        <p style="text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.5);">
                            Add your first task to get started!
                        </p>
                    </div>
                `;
                updateTodoStats();
                return;
            }
            
            todoList.innerHTML = '';
            
            todos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                todoItem.innerHTML = `
                    <div class="todo-checkbox ${todo.completed ? 'checked' : ''}" onclick="toggleTodo(${todo.id})"></div>
                    <div class="todo-text">${todo.text}</div>
                    <div class="todo-priority priority-${todo.priority}">${todo.priority}</div>
                    <button class="todo-delete" onclick="deleteTodo(${todo.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                todoList.appendChild(todoItem);
            });
            
            updateTodoStats();
        }

        function addTodo() {
            const input = document.getElementById('newTodo');
            const priority = document.getElementById('todoPriority').value;
            
            if (!input.value.trim()) {
                showNotification('Please enter a task');
                return;
            }
            
            db.addTodo({
                text: input.value,
                priority
            });
            
            input.value = '';
            loadTodos();
            showNotification('Task added! ✅');
        }

        function handleTodoKeyPress(e) {
            if (e.key === 'Enter') {
                addTodo();
            }
        }

        function toggleTodo(id) {
            db.toggleTodo(id);
            loadTodos();
            updateUserStats();
        }

        function deleteTodo(id) {
            if (confirm('Delete this task?')) {
                db.deleteTodo(id);
                loadTodos();
                updateUserStats();
                showNotification('Task deleted');
            }
        }

        function updateTodoStats() {
            const todos = db.getTodos();
            const total = todos.length;
            const completed = todos.filter(t => t.completed).length;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
        }

        // ===== NOTES =====
        function loadNotes() {
            const notesContainer = document.getElementById('notesContainer');
            if (!notesContainer) return;
            
            const notes = db.getNotes();
            
            if (notes.length === 0) {
                notesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; grid-column: 1 / -1;">
                        <div class="label-container">
                            <span class="label label-secondary">
                                <i class="fas fa-sticky-note"></i> No notes yet
                            </span>
                        </div>
                        <p style="text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.5);">
                            Create your first note!
                        </p>
                    </div>
                `;
                return;
            }
            
            notesContainer.innerHTML = '';
            
            notes.slice().reverse().forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                noteCard.innerHTML = `
                    <div class="note-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-content">${note.content.length > 200 ? note.content.substring(0, 200) + '...' : note.content}</div>
                    <div class="note-date">
                        <span>${new Date(note.createdAt).toLocaleDateString()}</span>
                        <div class="note-actions">
                            <button class="note-action-btn" onclick="deleteNote(${note.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                notesContainer.appendChild(noteCard);
            });
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            
            if (!content.trim()) {
                showNotification('Please enter note content');
                return;
            }
            
            db.addNote({
                title,
                content
            });
            
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            
            loadNotes();
            updateUserStats();
            showNotification('Note saved! 📝');
        }

        function clearNoteForm() {
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
        }

        function deleteNote(id) {
            if (confirm('Delete this note?')) {
                db.deleteNote(id);
                loadNotes();
                updateUserStats();
                showNotification('Note deleted');
            }
        }

        // ===== CALENDAR =====
        function updateCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            const currentMonth = document.getElementById('currentMonth');
            
            if (!calendarDays) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            currentMonth.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Get first day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Clear calendar
            calendarDays.innerHTML = '';
            
            // Add day labels
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                calendarDays.appendChild(dayElement);
            });
            
            // Add empty cells for days before first day
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyElement = document.createElement('div');
                emptyElement.className = 'calendar-date';
                calendarDays.appendChild(emptyElement);
            }
            
            // Add days of month
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateElement = document.createElement('div');
                dateElement.className = 'calendar-date';
                dateElement.textContent = day;
                
                const dateKey = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const hasFocus = db.calendar[dateKey] && db.calendar[dateKey].focusTime > 0;
                
                if (hasFocus) {
                    dateElement.classList.add('has-focus');
                }
                
                // Check if today
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dateElement.classList.add('today');
                }
                
                // Check if active
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dateElement.classList.add('active');
                }
                
                dateElement.onclick = () => showDayDetails(dateKey, day);
                calendarDays.appendChild(dateElement);
            }
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        }

        function showDayDetails(dateKey, day) {
            const dayDetails = document.getElementById('dayDetails');
            const selectedDate = document.getElementById('selectedDate');
            const dayStats = document.getElementById('dayStats');
            
            const date = new Date(dateKey);
            selectedDate.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const data = db.calendar[dateKey];
            
            if (data) {
                const hours = Math.floor(data.focusTime / 3600);
                const minutes = Math.floor((data.focusTime % 3600) / 60);
                
                dayStats.innerHTML = `
                    <div class="stats-grid" style="margin-top: 1rem;">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-value">${hours}h ${minutes}m</div>
                            <div class="stat-label">Focus Time</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                            <div class="stat-value">${data.sessions}</div>
                            <div class="stat-label">Sessions</div>
                        </div>
                    </div>
                `;
            } else {
                dayStats.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="label-container">
                            <span class="label label-secondary">
                                <i class="fas fa-calendar-day"></i> No sessions
                            </span>
                        </div>
                        <p style="text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.5);">
                            No focus sessions recorded for this day
                        </p>
                    </div>
                `;
            }
            
            dayDetails.style.display = 'block';
        }

        // ===== MARKETPLACE =====
        function renderMarketplace() {
            const grid = document.getElementById('marketplaceGrid');
            if (!grid) return;
            
            marketItems.forEach((item, index) => {
                const isOwned = db.ownedItems.includes(item.id);
                const canAfford = db.user.coins >= item.price;
                
                const itemEl = document.createElement('div');
                itemEl.className = `market-item ${isOwned ? 'owned' : ''}`;
                itemEl.style.animationDelay = `${index * 0.1}s`;
                itemEl.innerHTML = `
                    ${item.rarity === 'legendary' || item.rarity === 'epic' ? 
                        `<div class="item-badge">${item.rarity.toUpperCase()}</div>` : ''}
                    
                    <div class="item-icon"><i class="${item.icon}"></i></div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-desc">${item.description}</div>
                    
                    <div class="item-stats">
                        <span class="rarity ${item.rarity}">${item.rarity.toUpperCase()}</span>
                        ${item.type === 'boost' ? '<span><i class="fas fa-bolt"></i> BOOST</span>' : ''}
                    </div>
                    
                    <div class="item-price">
                        <div class="price-tag"><i class="fas fa-coins"></i> ${item.price}</div>
                        <button class="buy-btn ${isOwned ? 'owned' : ''}" 
                                onclick="purchaseItem(${item.id})" 
                                ${isOwned || !canAfford ? 'disabled' : ''}>
                            ${isOwned ? 'OWNED' : (canAfford ? 'BUY NOW' : `NEED ${item.price - db.user.coins}`)}
                        </button>
                    </div>
                `;
                
                grid.appendChild(itemEl);
            });
        }

        function filterMarket(category) {
            const filtered = category === 'all' 
                ? marketItems 
                : marketItems.filter(item => item.category === category);
            
            const grid = document.getElementById('marketplaceGrid');
            grid.innerHTML = '';
            
            filtered.forEach((item, index) => {
                const isOwned = db.ownedItems.includes(item.id);
                const canAfford = db.user.coins >= item.price;
                
                const itemEl = document.createElement('div');
                itemEl.className = `market-item ${isOwned ? 'owned' : ''}`;
                itemEl.style.animationDelay = `${index * 0.1}s`;
                itemEl.innerHTML = `
                    ${item.rarity === 'legendary' || item.rarity === 'epic' ? 
                        `<div class="item-badge">${item.rarity.toUpperCase()}</div>` : ''}
                    
                    <div class="item-icon"><i class="${item.icon}"></i></div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-desc">${item.description}</div>
                    
                    <div class="item-stats">
                        <span class="rarity ${item.rarity}">${item.rarity.toUpperCase()}</span>
                        ${item.type === 'boost' ? '<span><i class="fas fa-bolt"></i> BOOST</span>' : ''}
                    </div>
                    
                    <div class="item-price">
                        <div class="price-tag"><i class="fas fa-coins"></i> ${item.price}</div>
                        <button class="buy-btn ${isOwned ? 'owned' : ''}" 
                                onclick="purchaseItem(${item.id})" 
                                ${isOwned || !canAfford ? 'disabled' : ''}>
                            ${isOwned ? 'OWNED' : (canAfford ? 'BUY NOW' : `NEED ${item.price - db.user.coins}`)}
                        </button>
                    </div>
                `;
                
                grid.appendChild(itemEl);
            });
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function purchaseItem(itemId) {
            try {
                db.purchaseItem(itemId);
                updateUserStats();
                renderMarketplace();
                showNotification('Item purchased! 🎁');
                
                // Apply visual effect for some items
                if (itemId === 202) { // Confetti
                    triggerConfetti();
                } else if (itemId === 201) { // Particles
                    createParticles();
                }
            } catch (error) {
                showNotification(error.message);
            }
        }

        // ===== MUSIC PLAYER =====
        function loadFocusMusic() {
            const grid = document.getElementById('focusMusicGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            musicTracks.forEach(track => {
                const trackEl = document.createElement('div');
                trackEl.className = 'music-track';
                trackEl.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem; color: ${track.color};">
                        <i class="${track.icon}"></i>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${track.name}</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Focus Music</div>
                `;
                trackEl.onclick = () => playMusic(track);
                grid.appendChild(trackEl);
            });
        }

        function playMusic(track) {
            // Stop current music
            if (activeMusic) {
                activeMusic.pause();
                activeMusic = null;
            }
            
            // Play new track
            activeMusic = new Audio(track.url);
            activeMusic.loop = true;
            activeMusic.volume = 0.5;
            
            activeMusic.play()
                .then(() => {
                    activeMusicTrack = track;
                    document.getElementById('currentTrackName').textContent = track.name;
                    document.getElementById('musicPlayer').style.display = 'block';
                    
                    // Update UI
                    document.querySelectorAll('.music-track').forEach(t => t.classList.remove('playing'));
                    event.target.closest('.music-track').classList.add('playing');
                    
                    showNotification(`Now playing: ${track.name} 🎵`);
                })
                .catch(error => {
                    console.error('Error playing music:', error);
                    showNotification('Could not play music. Please check your connection.');
                });
        }

        function pauseMusic() {
            if (activeMusic && !activeMusic.paused) {
                activeMusic.pause();
                showNotification('Music paused ⏸️');
            }
        }

        function stopMusic() {
            if (activeMusic) {
                activeMusic.pause();
                activeMusic.currentTime = 0;
                activeMusic = null;
                activeMusicTrack = null;
                
                document.getElementById('musicPlayer').style.display = 'none';
                document.querySelectorAll('.music-track').forEach(t => t.classList.remove('playing'));
                
                showNotification('Music stopped ⏹️');
            }
        }

        // ===== CHARTS =====
        function updateCharts() {
            // Weekly Focus Chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const weekData = [];
            
            // Get data for last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                const data = db.calendar[dateKey];
                weekData.push(data ? Math.floor(data.focusTime / 60) : 0); // Convert to minutes
            }
            
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Focus Time (minutes)',
                        data: weekData,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
            
            // Productivity Distribution Chart
            const productivityCtx = document.getElementById('productivityChart').getContext('2d');
            const productivityData = {
                focus: Math.floor(db.stats.totalFocusTime / 3600),
                tasks: db.stats.completedTasks,
                habits: db.habits.reduce((sum, h) => sum + h.totalCompletions, 0),
                notes: db.stats.totalNotes
            };
            
            if (productivityChart) {
                productivityChart.destroy();
            }
            
            productivityChart = new Chart(productivityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Focus Hours', 'Completed Tasks', 'Habit Completions', 'Notes'],
                    datasets: [{
                        data: [productivityData.focus, productivityData.tasks, productivityData.habits, productivityData.notes],
                        backgroundColor: [
                            'rgba(0, 212, 255, 0.8)',
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(157, 78, 221, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderColor: [
                            'rgba(0, 212, 255, 1)',
                            'rgba(76, 175, 80, 1)',
                            'rgba(157, 78, 221, 1)',
                            'rgba(255, 193, 7, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // ===== QUESTS =====
        function renderQuests() {
            const questsGrid = document.getElementById('questsGrid');
            if (!questsGrid) return;
            
            const quests = db.getQuests();
            
            questsGrid.innerHTML = '';
            
            let completedCount = 0;
            
            quests.forEach(quest => {
                if (quest.completed) completedCount++;
                
                const questCard = document.createElement('div');
                questCard.className = `quest-card ${quest.completed ? 'completed' : ''}`;
                questCard.innerHTML = `
                    <h3 style="margin-bottom: 0.5rem; color: ${quest.completed ? 'var(--success)' : 'var(--light)'};">${quest.name}</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem; font-size: 0.9rem;">${quest.description}</p>
                    
                    ${quest.progress !== undefined ? `
                        <div class="progress-bar" style="margin-bottom: 0.5rem;">
                            <div class="progress-fill" style="width: ${(quest.progress / quest.target) * 100}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                            <span>Progress: ${quest.progress}/${quest.target}</span>
                            <span>${quest.completed ? 'Completed!' : ''}</span>
                        </div>
                    ` : ''}
                    
                    <div class="quest-reward">
                        <i class="fas fa-coins"></i>
                        <span>+${quest.reward} coins</span>
                        ${quest.completed ? '<i class="fas fa-check" style="margin-left: auto;"></i>' : ''}
                    </div>
                `;
                questsGrid.appendChild(questCard);
            });
            
            document.getElementById('questsCompleted').textContent = completedCount;
            document.getElementById('totalQuests').textContent = quests.length;
        }

        // ===== ACHIEVEMENTS =====
        function renderAchievements() {
            const achievementsGrid = document.getElementById('achievementsGrid');
            if (!achievementsGrid) return;
            
            const achievements = db.achievements;
            
            achievementsGrid.innerHTML = '';
            
            achievements.forEach(achievement => {
                const progressPercentage = Math.min(100, (achievement.progress / achievement.target) * 100);
                
                const achievementCard = document.createElement('div');
                achievementCard.className = `achievement-card ${achievement.unlocked ? 'unlocked' : ''}`;
                achievementCard.innerHTML = `
                    <div class="achievement-icon">
                        <i class="${achievement.icon}"></i>
                    </div>
                    <h3 style="margin-bottom: 0.5rem; color: ${achievement.unlocked ? 'var(--primary)' : 'rgba(255,255,255,0.7)'};">${achievement.name}</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem; font-size: 0.9rem;">${achievement.description}</p>
                    
                    <div class="achievement-progress">
                        <div class="progress-text">
                            <span>${achievement.unlocked ? 'UNLOCKED' : `${progressPercentage.toFixed(0)}%`}</span>
                            <span>${achievement.points} pts</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    
                    ${achievement.unlocked ? `
                        <div class="label-container" style="margin-top: 1rem;">
                            <span class="label label-success">
                                <i class="fas fa-unlock"></i> Unlocked
                            </span>
                        </div>
                    ` : ''}
                `;
                achievementsGrid.appendChild(achievementCard);
            });
        }

        // ===== USER STATS =====
        function updateUserStats() {
            if (!currentUser) return;
            
            // Update header
            document.getElementById('coins').textContent = currentUser.coins;
            document.getElementById('lvl').textContent = currentUser.level;
            document.getElementById('headerUsername').textContent = currentUser.username;
            
            // Calculate XP percentage
            const xpNeeded = currentUser.level * 100;
            const xpPercent = Math.min(100, (currentUser.xp / xpNeeded) * 100);
            document.getElementById('xpBadge').textContent = `${Math.round(xpPercent)}%`;
            
            // Update stats section
            const hours = Math.floor(db.stats.totalFocusTime / 3600);
            document.getElementById('totalCoins').textContent = currentUser.coins;
            document.getElementById('currentStreak').textContent = db.stats.currentStreak;
            document.getElementById('totalFocusTime').textContent = `${hours}h`;
            document.getElementById('activeDays').textContent = Object.keys(db.calendar).length;
            
            // Update progress bars
            const maxCoins = Math.max(5000, currentUser.totalCoinsEarned);
            document.getElementById('coinsProgress').style.width = `${Math.min(100, currentUser.coins / maxCoins * 100)}%`;
            document.getElementById('streakProgress').style.width = `${Math.min(100, db.stats.currentStreak / 30 * 100)}%`;
            document.getElementById('timeProgress').style.width = `${Math.min(100, db.stats.totalFocusTime / 360000 * 100)}%`;
            document.getElementById('daysProgress').style.width = `${Math.min(100, Object.keys(db.calendar).length / 365 * 100)}%`;
        }

        function checkActiveBoosts() {
            const now = Date.now();
            Object.keys(db.activeBoosts).forEach(boostType => {
                const boost = db.activeBoosts[boostType];
                if (boost.expires < now) {
                    delete db.activeBoosts[boostType];
                }
            });
            db.saveAllData();
        }

        // ===== SETTINGS =====
        function loadSettings() {
            // Load current settings
            document.getElementById('soundEffects').checked = db.settings.soundEffects;
            document.getElementById('focusMusic').checked = db.settings.focusMusic;
            document.getElementById('notificationSounds').checked = db.settings.notificationSounds;
            document.getElementById('focusReminders').checked = db.settings.focusReminders;
            document.getElementById('dailyGoals').checked = db.settings.dailyGoals;
            document.getElementById('questNotifications').checked = db.settings.questNotifications;
            document.getElementById('defaultTimer').value = db.settings.defaultTimer;
            document.getElementById('autoBreak').checked = db.settings.autoBreak;
            
            // Add event listeners
            document.getElementById('soundEffects').onchange = saveSettings;
            document.getElementById('focusMusic').onchange = saveSettings;
            document.getElementById('notificationSounds').onchange = saveSettings;
            document.getElementById('focusReminders').onchange = saveSettings;
            document.getElementById('dailyGoals').onchange = saveSettings;
            document.getElementById('questNotifications').onchange = saveSettings;
            document.getElementById('defaultTimer').onchange = saveSettings;
            document.getElementById('autoBreak').onchange = saveSettings;
        }

        function saveSettings() {
            const settings = {
                soundEffects: document.getElementById('soundEffects').checked,
                focusMusic: document.getElementById('focusMusic').checked,
                notificationSounds: document.getElementById('notificationSounds').checked,
                focusReminders: document.getElementById('focusReminders').checked,
                dailyGoals: document.getElementById('dailyGoals').checked,
                questNotifications: document.getElementById('questNotifications').checked,
                defaultTimer: parseInt(document.getElementById('defaultTimer').value) || 25,
                autoBreak: document.getElementById('autoBreak').checked
            };
            
            db.updateSettings(settings);
            showNotification('Settings saved! ⚙️');
        }

        // ===== NAVIGATION =====
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load section-specific content
            switch(sectionId) {
                case 'stats':
                    updateCharts();
                    break;
                case 'habits':
                    loadHabits();
                    break;
                case 'todo':
                    loadTodos();
                    break;
                case 'notes':
                    loadNotes();
                    break;
                case 'calendar':
                    updateCalendar();
                    break;
                case 'marketplace':
                    renderMarketplace();
                    break;
                case 'quests':
                    renderQuests();
                    break;
                case 'achievements':
                    renderAchievements();
                    break;
            }
        }

        // ===== PROFILE MODAL =====
        function showProfileModal() {
            const modalAvatar = document.getElementById('modalAvatar');
            const modalUsername = document.getElementById('modalUsername');
            const modalLevel = document.getElementById('modalLevel');
            const editUsername = document.getElementById('editUsername');
            const editDailyQuote = document.getElementById('editDailyQuote');
            const modalAvatarSelection = document.getElementById('modalAvatarSelection');
            
            // Set current values
            modalAvatar.textContent = currentUser.avatar;
            modalUsername.textContent = currentUser.username;
            modalLevel.textContent = `Level ${currentUser.level} • ${currentUser.xp} XP`;
            editUsername.value = currentUser.username;
            editDailyQuote.value = currentUser.dailyQuote || '';
            
            // Populate avatar selection
            modalAvatarSelection.innerHTML = '';
            avatars.slice(0, 12).forEach(avatar => {
                const avatarOption = document.createElement('div');
                avatarOption.className = 'avatar-option';
                if (avatar === currentUser.avatar) avatarOption.classList.add('selected');
                avatarOption.textContent = avatar;
                avatarOption.onclick = () => {
                    document.querySelectorAll('#modalAvatarSelection .avatar-option').forEach(opt => opt.classList.remove('selected'));
                    avatarOption.classList.add('selected');
                    modalAvatar.textContent = avatar;
                };
                modalAvatarSelection.appendChild(avatarOption);
            });
            
            document.getElementById('profileModal').style.display = 'flex';
        }

        function updateProfile() {
            const newUsername = document.getElementById('editUsername').value.trim();
            const newAvatar = document.querySelector('#modalAvatarSelection .avatar-option.selected').textContent;
            const newDailyQuote = document.getElementById('editDailyQuote').value.trim();
            
            if (!newUsername) {
                showNotification('Please enter a name');
                return;
            }
            
            db.updateUser({
                username: newUsername,
                avatar: newAvatar,
                dailyQuote: newDailyQuote || currentUser.dailyQuote
            });
            
            currentUser = db.user;
            updateUserStats();
            
            closeModal('profileModal');
            showNotification('Profile updated! ✅');
        }

        // ===== MODAL FUNCTIONS =====
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ===== APP RESTRICTION =====
        function enableAppRestriction() {
            if (db.user.coins < 10) {
                showNotification('You need at least 10 coins to enable restriction');
                return;
            }
            
            const restrictionTime = parseInt(document.getElementById('minutes').value) || 25;
            isRestrictionActive = true;
            restrictionEndTime = Date.now() + (restrictionTime * 60000);
            
            // Deduct coins
            db.addCoins(-10);
            updateUserStats();
            
            // Show restriction modal
            document.getElementById('restrictionModal').style.display = 'flex';
            
            // Update restriction timer
            restrictionInterval = setInterval(updateRestrictionTimer, 1000);
            
            showNotification('App restriction enabled! Stay focused! 🔒');
        }

        function disableAppRestriction() {
            if (isRestrictionActive) {
                isRestrictionActive = false;
                clearInterval(restrictionInterval);
                document.getElementById('restrictionModal').style.display = 'none';
                showNotification('App restriction disabled');
            }
        }

        function emergencyUnlock() {
            if (db.user.coins >= 50) {
                db.addCoins(-50);
                updateUserStats();
                disableAppRestriction();
                showNotification('Emergency unlock activated! -50 coins');
            } else {
                showNotification('Not enough coins for emergency unlock');
            }
        }

        function updateRestrictionTimer() {
            if (!isRestrictionActive || !restrictionEndTime) return;
            
            const remaining = Math.max(0, restrictionEndTime - Date.now());
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            document.getElementById('restrictionTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (remaining <= 0) {
                disableAppRestriction();
                showNotification('Restriction period complete! Great focus session! 🎉');
                triggerConfetti();
            }
        }

        // ===== LEAVE PREVENTION =====
        function setupLeavePrevention() {
            window.addEventListener('beforeunload', (e) => {
                if (preventLeave) {
                    e.preventDefault();
                    e.returnValue = '';
                    showNotification('Timer is running! Complete your focus session.');
                    return '';
                }
            });
        }

        // ===== UTILITIES =====
        function showNotification(message) {
            if (!db.settings.notificationSounds && !db.settings.focusReminders) return;
            
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            text.textContent = message;
            notification.classList.add('show');
            
            // Play notification sound if enabled
            if (db.settings.notificationSounds) {
                playNotificationSound();
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function playCompletionSound() {
            if (!db.settings.soundEffects) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio context not supported');
            }
        }

        function playNotificationSound() {
            if (!db.settings.notificationSounds) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio context not supported');
            }
        }

        function triggerConfetti() {
            if (!window.confettiEnabled) return;
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                
                const colors = ['#00D4FF', '#9D4EDD', '#FF6B6B', '#4CAF50', '#FF9800'];
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        function createParticles() {
            if (!document.body.classList.contains('particles-enabled')) return;
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'fixed';
                particle.style.width = '4px';
                particle.style.height = '4px';
                particle.style.background = 'var(--primary)';
                particle.style.borderRadius = '50%';
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.top = '-10px';
                particle.style.zIndex = '9999';
                particle.style.pointerEvents = 'none';
                document.body.appendChild(particle);
                
                particle.animate([
                    { transform: 'translateY(0) scale(1)', opacity: 1 },
                    { transform: `translateY(${window.innerHeight}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 2000 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
                });
                
                setTimeout(() => particle.remove(), 3000);
            }
        }

        function toggleOrbEffect() {
            const orb = document.querySelector('.orb');
            if (orb.classList.contains('floating')) {
                orb.classList.remove('floating');
                showNotification('Orb effect paused');
            } else {
                orb.classList.add('floating');
                showNotification('Orb effect active! ✨');
            }
        }

        // ===== DATA MANAGEMENT =====
        function exportAllData() {
            const data = db.exportData();
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `focus-arena-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('All data exported successfully! 📥');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        db.importData(data);
                        currentUser = db.user;
                        initializeApp();
                        showNotification('Data imported successfully! 📤');
                        triggerConfetti();
                    } catch (error) {
                        showNotification('Error importing data: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function resetAppData() {
            if (confirm('Are you sure you want to reset all data? This cannot be undone!')) {
                db.resetData();
                location.reload();
            }
        }

        // ===== GAME-LIKE FEATURES =====
        // 1. Daily login rewards
        function checkDailyReward() {
            const today = new Date().toDateString();
            const lastReward = localStorage.getItem('lastDailyReward');
            
            if (lastReward !== today) {
                const reward = 100 + (db.stats.currentStreak * 10);
                db.addCoins(reward);
                localStorage.setItem('lastDailyReward', today);
                showNotification(`🎁 Daily Reward! +${reward} coins for your ${db.stats.currentStreak}-day streak!`);
                updateUserStats();
            }
        }

        // 2. Random events
        function triggerRandomEvent() {
            const events = [
                {
                    name: "Productivity Surge",
                    message: "You feel extra focused! Next session earns 2x XP!",
                    effect: () => {
                        db.activeBoosts.xpMultiplier = { value: 2, expires: Date.now() + 1800000 };
                        showNotification("Productivity surge! 2x XP for 30 minutes! ⚡");
                    }
                },
                {
                    name: "Lucky Coin",
                    message: "You found a lucky coin!",
                    effect: () => {
                        db.addCoins(50);
                        showNotification("💰 Lucky coin found! +50 coins!");
                        updateUserStats();
                    }
                },
                {
                    name: "Motivation Boost",
                    message: "You're feeling extra motivated!",
                    effect: () => {
                        const randomQuote = [
                            "You're doing great! Keep going! 💪",
                            "Every minute counts! Stay focused! ⏰",
                            "You're building an empire of productivity! 🏰",
                            "Small steps lead to big achievements! 🚀"
                        ][Math.floor(Math.random() * 4)];
                        showNotification(randomQuote);
                    }
                }
            ];
            
            if (Math.random() < 0.1) { // 10% chance
                const event = events[Math.floor(Math.random() * events.length)];
                event.effect();
            }
        }

        // 3. Streak celebrations
        function checkStreakCelebration() {
            if (db.stats.currentStreak > 0 && db.stats.currentStreak % 7 === 0) {
                const bonus = db.stats.currentStreak * 25;
                db.addCoins(bonus);
                showNotification(`🎉 ${db.stats.currentStreak}-day streak! +${bonus} coins!`);
                triggerConfetti();
                updateUserStats();
            }
        }

        // Initialize game features
        setTimeout(() => {
            checkDailyReward();
            triggerRandomEvent();
            checkStreakCelebration();
            
            // Check every 5 minutes for random events
            setInterval(triggerRandomEvent, 300000);
        }, 5000);
    </script>
</body>
</html>
